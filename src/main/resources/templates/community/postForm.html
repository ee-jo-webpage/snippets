<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 작성</title>

    <!-- jQuery (가장 먼저) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap 4 (Summernote와 완벽 호환) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Summernote (Bootstrap 4 완벽 호환) -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6357FF;
            --secondary-color: #8075FF;
            --accent-color: #9F97FF;
            --background-gradient: linear-gradient(135deg, #F0F2FF 0%, #E6E9FF 100%);
            --text-dark: #333344;
            --text-muted: #666677;
            --border-color: #EAEAEA;
            --shadow-small: 0 2px 8px rgba(99, 87, 255, 0.08);
            --shadow-medium: 0 4px 12px rgba(99, 87, 255, 0.12);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            background: var(--background-gradient);
            min-height: 100vh;
        }

        /* 헤더 스타일 */
        .community-header {
            background-color: #ffffff;
            color: var(--text-dark);
            padding: 1rem 0;
            box-shadow: var(--shadow-small);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .community-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            justify-content: flex-end;
        }

        .header-controls .btn {
            padding: 0.5rem 1rem;
            border-radius: 24px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn-outline {
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            background-color: transparent;
        }

        .header-btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-small);
        }

        /* 메인 컨테이너 */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
            max-width: 1200px;
            margin: 1.5rem auto;
            gap: 1.5rem;
            padding: 0 1rem;
        }

        /* 사이드바 스타일 */
        .sidebar {
            width: 250px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-small);
            overflow: hidden;
            flex-shrink: 0;
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .sidebar-header {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .category-menu {
            padding: 0.5rem 0;
            margin: 0;
            background: white;
        }

        .category-item {
            padding: 0.2rem 0.8rem;
        }

        .category-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            border-radius: 8px;
            cursor: pointer;
        }

        .category-link:hover {
            background: #f8f9fa;
            color: var(--primary-color);
        }

        .category-link.active {
            background: #f0f2ff;
            color: var(--primary-color);
            font-weight: 500;
        }

        .category-icon {
            margin-right: 0.75rem;
            width: 16px;
            text-align: center;
            color: var(--primary-color);
        }

        .category-count {
            margin-left: auto;
            background: #f0f2ff;
            color: var(--primary-color);
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
        }

        .category-link.active .category-count {
            background: var(--primary-color);
            color: white;
        }

        /* 메인 콘텐츠 영역 */
        .main-content {
            flex: 1;
        }

        .card {
            box-shadow: var(--shadow-small);
            border: none;
            border-radius: 12px;
            background: white;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            border-radius: 12px 12px 0 0;
        }

        .card-body {
            padding: 2rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 87, 255, 0.25);
        }

        .required {
            color: #dc3545;
        }

        /* Summernote 스타일 */
        .note-editor {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .note-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            padding: 8px;
        }

        .note-btn-group {
            margin-right: 8px;
            margin-bottom: 4px;
        }

        .note-btn {
            padding: 4px 8px;
            margin: 1px;
            border: 1px solid var(--border-color);
            background-color: white;
            border-radius: 3px;
        }

        .note-btn:hover {
            background-color: #e9ecef;
        }

        .note-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 파일 업로드 스타일 */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: border-color 0.3s ease;
            background-color: #fafafa;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-small);
        }

        .file-item .file-info {
            flex-grow: 1;
        }

        .file-item .file-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .file-item .file-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .file-item .remove-file {
            color: #dc3545;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-item .remove-file:hover {
            background-color: #f8d7da;
        }

        /* 버튼 스타일 */
        .btn-primary-custom {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 24px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            color: white;
        }

        .btn-outline-custom {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1.5rem;
            border-radius: 24px;
            transition: all 0.3s ease;
        }

        .btn-outline-custom:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-draft {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 24px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-draft:hover {
            background-color: #5a6268;
            border-color: #545b62;
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }

        /* 임시저장 상태 */
        .draft-status {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1050;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .draft-status.saving {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .draft-status.saved {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .draft-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 모달 스타일 */
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-bottom: none;
        }

        .modal-header .btn-close {
            color: white;
        }

        /* 커뮤니티 로고 링크 스타일 */
        .community-logo-link {
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .community-logo-link:hover {
            color: var(--secondary-color);
            text-decoration: none;
            transform: translateY(-1px);
        }

        .community-logo-link:focus {
            color: var(--primary-color);
            text-decoration: none;
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* 로고 호버 효과 */
        .community-logo-link i {
            transition: transform 0.3s ease;
        }

        .community-logo-link:hover i {
            transform: scale(1.1);
        }

        /* 홈 버튼 스타일 */
        .home-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: var(--shadow-small);
        }

        .home-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            text-decoration: none;
        }

        .home-btn:focus {
            outline: 3px solid rgba(99, 87, 255, 0.3);
            outline-offset: 2px;
            text-decoration: none;
        }

        .home-btn:active {
            transform: translateY(0);
        }

        /* 홈 버튼 아이콘 애니메이션 */
        .home-btn i {
            transition: transform 0.3s ease;
        }

        .home-btn:hover i {
            transform: scale(1.1);
        }

        .file-item.removing {
            opacity: 0.5;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .file-item {
            transition: all 0.3s ease;
        }

        .file-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* 반응형 조정 */
        @media (max-width: 768px) {
            .home-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 0.5rem !important;
            }

            .community-header h1 {
                font-size: 1.3rem;
            }
        }

        /* postEditDetail.html용 특별 스타일 */
        .page-header-with-home {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .page-header-with-home .home-btn {
            flex-shrink: 0;
        }

        .page-header-with-home h1 {
            margin: 0;
            flex-grow: 1;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .sidebar {
                width: 100%;
                position: static;
            }

            .category-menu {
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
            }

            .category-item {
                flex-shrink: 0;
            }

            .category-link {
                padding: 0.75rem 1rem;
                white-space: nowrap;
            }

            .card-header,
            .card-body {
                padding: 1rem;
            }


        }
    </style>
</head>
<body>

<!-- 임시저장 상태 표시 -->
<div id="draftStatus" class="draft-status" style="display: none;">
    <span id="draftStatusText">저장 중...</span>
</div>

<!-- 헤더 -->
<div class="community-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <!-- 커뮤니티 로고 -->
                <h1 class="mb-0">
                    <a href="/community" class="community-logo-link">
                        <i class="fas fa-comments me-2"></i>
                        커뮤니티
                    </a>
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="header-controls">
                    <!-- 메인 홈 버튼 -->
                    <a href="/app" class="home-btn" title="메인 홈으로">
                        <i class="fas fa-home"></i>
                    </a>

                    <!-- 알림 버튼 -->
                    <button class="btn header-btn-outline position-relative" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                              id="notificationCount" style="display: none;">0</span>
                    </button>

                    <!-- 임시저장 버튼 -->
                    <button class="btn header-btn-outline" id="draftBtn">
                        <i class="fas fa-save me-1"></i>
                        임시저장
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>a

<!-- 메인 컨테이너 -->
<div class="main-container">
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">게시판</h3>
        </div>
        <nav class="category-menu">
            <!-- 전체 게시글 -->
            <div class="category-item">
                <a href="/community" class="category-link">
                    <i class="fas fa-home category-icon"></i>
                    전체 게시글
                    <span class="category-count">123</span>
                </a>
            </div>

            <!-- 카테고리 목록 (서버에서 동적으로 생성) - URL 수정 -->
            <div class="category-item" th:each="category : ${categories}">
                <a th:href="@{/community(categoryId=${category.categoryId})}"
                   class="category-link">
                    <i class="fas fa-folder category-icon"></i>
                    <span th:text="${category.name}">카테고리명</span>
                    <span class="category-count">42</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    게시글 작성
                </h2>
            </div>
            <div class="card-body">
                <form id="postForm" th:action="@{/community/post/new}" method="post" enctype="multipart/form-data">

                    <!-- 카테고리 선택 -->
                    <div class="mb-3">
                        <label for="categoryId" class="form-label">
                            <i class="fas fa-folder me-1"></i>
                            게시판 선택 <span class="required">*</span>
                        </label>
                        <select id="categoryId" name="categoryId" class="form-select" required>
                            <option value="">게시판을 선택하세요</option>
                            <option th:each="category : ${categories}"
                                    th:value="${category.categoryId}"
                                    th:text="${category.name}"></option>
                        </select>
                    </div>

                    <!-- 제목 -->
                    <div class="mb-3">
                        <label for="title" class="form-label">
                            <i class="fas fa-heading me-1"></i>
                            제목 <span class="required">*</span>
                        </label>
                        <input type="text" id="title" name="title" class="form-control"
                               placeholder="제목을 입력하세요" required>
                    </div>

                    <!-- Summernote 에디터 -->
                    <div class="mb-3">
                        <label for="summernote" class="form-label">
                            <i class="fas fa-align-left me-1"></i>
                            내용 <span class="required">*</span>
                        </label>
                        <textarea id="summernote" name="content"></textarea>
                    </div>

                    <!-- 파일 첨부 영역 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>
                            파일 첨부
                        </label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-file-upload fa-2x mb-2 text-muted"></i>
                            <p class="mb-2">파일을 드래그하여 업로드하거나 클릭하여 선택하세요</p>
                            <input type="file" id="files" name="files" multiple class="form-control d-none"
                                   accept=".pdf,.doc,.docx,.hwp,.txt,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.jpg,.jpeg,.png,.gif">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="$('#files').click()">
                                <i class="fas fa-plus me-1"></i>파일 선택
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    지원 형식: 문서(PDF, DOC, HWP 등), 이미지(JPG, PNG, GIF), 압축파일 등 (최대 10MB)
                                </small>
                            </div>
                        </div>
                        <div id="fileList" class="mt-3"></div>
                    </div>

                    <!-- 공지사항 설정 -->
                    <div class="mb-4 form-check">
                        <input type="checkbox" id="isNotice" name="isNotice" class="form-check-input" value="true">
                        <label for="isNotice" class="form-check-label">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            공지사항으로 등록
                        </label>
                    </div>

                    <!-- 버튼 영역 -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-draft me-2" id="saveDraftBtn">
                                <i class="fas fa-save me-1"></i>
                                임시저장
                            </button>
                            <span id="lastSavedTime" class="text-muted small"></span>
                        </div>
                        <div>
                            <a href="/community" class="btn btn-outline-custom me-2">
                                <i class="fas fa-times me-1"></i>
                                취소
                            </a>
                            <button type="submit" class="btn btn-primary-custom">
                                <i class="fas fa-paper-plane me-1"></i>
                                등록
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 임시저장 불러오기 모달 -->
<div class="modal fade" id="draftModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-open me-2"></i>
                    임시저장 불러오기
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="draftList">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i>
                        임시저장 목록을 불러오는 중...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let selectedFiles = [];
    let currentDraftId = null;
    let lastSavedData = {};

    $(document).ready(function() {
        // 초기화
        initializeSummernote();
        setupFileDragDrop();

        // 이벤트 바인딩
        $('#saveDraftBtn').click(saveDraft);
        $('#loadDraftBtn').click(loadDraftList);

        // URL 파라미터에서 draftId 확인
        const urlParams = new URLSearchParams(window.location.search);
        const draftId = urlParams.get('draftId');
        if (draftId) {
            loadDraft(draftId);
        }

        // 폼 변경 감지
        $('#title, #categoryId').on('input change', function() {
            updateLastSavedData();
        });

        // 폼 제출 이벤트
        $('#postForm').on('submit', function(e) {
            e.preventDefault();

            const title = $('#title').val().trim();
            const content = $('#summernote').summernote('code');
            const categoryId = $('#categoryId').val();

            if (!categoryId) {
                showToast('게시판을 선택해주세요.', 'warning');
                return;
            }

            if (!title) {
                showToast('제목을 입력해주세요.', 'warning');
                return;
            }

            if (content.trim() === '<p><br></p>' || !content.trim()) {
                showToast('내용을 입력해주세요.', 'warning');
                return;
            }

            if (confirm('게시글을 등록하시겠습니까?')) {
                // beforeunload 이벤트 리스너 제거 (나가기 알림 방지)
                window.removeEventListener('beforeunload', beforeUnloadHandler);

                // 임시저장이 있으면 삭제
                if (currentDraftId) {
                    $.ajax({
                        url: `/api/community/draft/${currentDraftId}`,
                        type: 'DELETE',
                        async: false
                    });
                }

                // FormData 생성하여 파일과 함께 제출
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('categoryId', categoryId);
                formData.append('isNotice', $('#isNotice').is(':checked'));

                // 선택된 파일들 추가
                selectedFiles.forEach(item => {
                    formData.append('files', item.file);
                });

                // AJAX로 제출
                $.ajax({
                    url: '/community/post/new',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // 성공시 리다이렉트 (서버에서 처리)
                        window.location.href = response.redirectUrl || '/community';
                    },
                    error: function(xhr) {
                        showToast('게시글 등록에 실패했습니다.', 'error');
                        console.error('등록 실패:', xhr);
                    }
                });
            }
        });

        // beforeunload 핸들러를 변수로 분리 (필요시 제거할 수 있도록)
        const beforeUnloadHandler = function(e) {
            if (hasContentChanged()) {
                e.preventDefault();
                e.returnValue = '작성 중인 내용이 있습니다. 정말 나가시겠습니까?';
                return e.returnValue;
            }
        };

    // Summernote 초기화
    function initializeSummernote() {
        if ($('#summernote').hasClass('note-editor')) {
            $('#summernote').summernote('destroy');
        }

        $('#summernote').summernote({
            height: 400,
            minHeight: 300,
            maxHeight: 600,
            focus: false,
            lang: 'ko-KR',
            placeholder: '내용을 입력하세요...',

            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['color', ['forecolor', 'backcolor']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video', 'hr']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],

            fontNames: [
                'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New',
                'Helvetica Neue', 'Helvetica', 'Impact', 'Lucida Grande',
                'Tahoma', 'Times New Roman', 'Verdana',
                '돋움', '굴림', '바탕', '궁서', '맑은 고딕', 'Malgun Gothic',
                '나눔고딕', 'Nanum Gothic', '나눔명조', 'Nanum Myeongjo'
            ],

            fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '22', '24', '28', '30', '36', '48', '64', '72'],

            callbacks: {
                onImageUpload: function(files) {
                    for (let i = 0; i < files.length; i++) {
                        uploadSummernoteImage(files[i], this);
                    }
                },
                onChange: function(contents) {
                    updateLastSavedData();
                }
            }
        });
    }

    // 파일 드래그 앤 드롭 설정
    function setupFileDragDrop() {
        const uploadArea = $('#fileUploadArea');

        uploadArea.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        uploadArea.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        uploadArea.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            const files = e.originalEvent.dataTransfer.files;
            handleFileSelection(files);
        });

        uploadArea.on('click', function(e) {
            if (e.target === this || e.target.closest('button')) {
                $('#files').click();
            }
        });

        $('#files').change(function() {
            handleFileSelection(this.files);
        });
    }

    // 파일 선택 처리
    function handleFileSelection(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            if (file.size > 10 * 1024 * 1024) {
                showToast(`${file.name} 파일이 너무 큽니다. 10MB 이하의 파일만 업로드 가능합니다.`, 'warning');
                continue;
            }

            addFileToList(file);
        }
        updateFileInput();
    }

    // 파일 목록에 추가
    function addFileToList(file) {
        const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        selectedFiles.push({id: fileId, file: file});

        const fileSize = (file.size / 1024).toFixed(1);
        const fileIcon = getFileIcon(file.name);

        const fileHtml = `
            <div class="file-item" data-file-id="${fileId}">
                <div class="file-info">
                    <div class="file-name">
                        <i class="${fileIcon} me-2"></i>
                        ${file.name}
                    </div>
                    <div class="file-meta">크기: ${fileSize} KB | 타입: ${file.type || '알 수 없음'}</div>
                </div>
                <i class="fas fa-times remove-file" onclick="removeFile('${fileId}')" title="파일 제거"></i>
            </div>
        `;

        $('#fileList').append(fileHtml);
    }

    // 파일 제거
        function removeFile(fileId) {
            const fileItem = $(`.file-item[data-file-id="${fileId}"]`);

            if (confirm('파일을 제거하시겠습니까?')) {
                // 애니메이션과 함께 제거
                fileItem.addClass('removing').fadeOut(300, function() {
                    // selectedFiles 배열에서 제거
                    selectedFiles = selectedFiles.filter(f => f.id !== fileId);

                    // DOM에서 제거
                    $(this).remove();

                    // 파일 입력 업데이트
                    updateFileInput();

                    console.log('파일 삭제됨:', fileId);
                    console.log('남은 파일:', selectedFiles.length + '개');

                    // 성공 메시지
                    showToast('파일이 제거되었습니다.', 'success');
                });
            }
        }

    // 파일 입력 업데이트
        function updateFileInput() {
            try {
                // DataTransfer 지원 브라우저
                if (window.DataTransfer) {
                    const dt = new DataTransfer();
                    selectedFiles.forEach(item => {
                        dt.items.add(item.file);
                    });

                    const fileInput = document.getElementById('files');
                    fileInput.files = dt.files;

                    console.log('파일 입력 업데이트 완료:', dt.files.length + '개');
                } else {
                    // DataTransfer 미지원 브라우저 (구형 브라우저)
                    console.log('DataTransfer 미지원, selectedFiles 배열만 관리');
                }
            } catch (error) {
                console.error('파일 입력 업데이트 실패:', error);
                // 오류 발생시 selectedFiles 배열만 관리
            }
        }


        // 파일 아이콘 가져오기
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'fas fa-file-pdf text-danger',
            'doc': 'fas fa-file-word text-primary',
            'docx': 'fas fa-file-word text-primary',
            'hwp': 'fas fa-file-alt text-info',
            'txt': 'fas fa-file-alt text-secondary',
            'xls': 'fas fa-file-excel text-success',
            'xlsx': 'fas fa-file-excel text-success',
            'ppt': 'fas fa-file-powerpoint text-warning',
            'pptx': 'fas fa-file-powerpoint text-warning',
            'zip': 'fas fa-file-archive text-dark',
            'rar': 'fas fa-file-archive text-dark',
            'jpg': 'fas fa-file-image text-info',
            'jpeg': 'fas fa-file-image text-info',
            'png': 'fas fa-file-image text-info',
            'gif': 'fas fa-file-image text-info'
        };
        return iconMap[ext] || 'fas fa-file text-muted';
    }

    // Summernote 이미지 업로드
    function uploadSummernoteImage(file, editor) {
        if (file.size > 5 * 1024 * 1024) {
            showToast('이미지 크기가 너무 큽니다. 5MB 이하의 이미지만 업로드 가능합니다.', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/community/upload-image',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                if (data.imageUrl) {
                    $(editor).summernote('insertImage', data.imageUrl);
                } else if (data.error) {
                    showToast('이미지 업로드 실패: ' + data.error, 'error');
                }
            },
            error: function() {
                showToast('이미지 업로드에 실패했습니다.', 'error');
            }
        });
    }

    // 임시저장 기능
    function saveDraft() {
        const data = getCurrentFormData();

        if (!data.title && data.content.trim() === '<p><br></p>') {
            showToast('제목이나 내용을 입력해주세요.', 'warning');
            return;
        }

        showDraftStatus('saving', '저장 중...');

        const requestData = {
            draftId: currentDraftId,
            title: data.title || '(제목 없음)',
            content: data.content,
            categoryId: data.categoryId || null
        };

        $.ajax({
            url: '/api/community/draft/save',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success) {
                    currentDraftId = response.draftId;
                    lastSavedData = data;

                    showDraftStatus('saved', '저장됨');
                    updateLastSavedTime();

                    setTimeout(hideDraftStatus, 2000);
                    showToast('임시저장되었습니다.', 'success');
                } else {
                    showDraftStatus('error', '저장 실패');
                    setTimeout(hideDraftStatus, 3000);
                    showToast('저장에 실패했습니다.', 'error');
                }
            },
            error: function() {
                showDraftStatus('error', '저장 실패');
                setTimeout(hideDraftStatus, 3000);
                showToast('저장 중 오류가 발생했습니다.', 'error');
            }
        });
    }

    // 임시저장 목록 로드
    function loadDraftList() {
        $('#draftList').html(`
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin"></i>
                임시저장 목록을 불러오는 중...
            </div>
        `);

        $.ajax({
            url: '/api/community/draft/list',
            type: 'GET',
            success: function(response) {
                renderDraftList(response.drafts || []);
                $('#draftModal').modal('show');
            },
            error: function() {
                $('#draftList').html(`
                    <div class="text-center py-4 text-danger">
                        임시저장 목록을 불러올 수 없습니다.
                    </div>
                `);
                $('#draftModal').modal('show');
            }
        });
    }

    // 임시저장 목록 렌더링
    function renderDraftList(drafts) {
        if (drafts.length === 0) {
            $('#draftList').html(`
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-folder-open fa-2x mb-3"></i>
                    <p>저장된 임시글이 없습니다.</p>
                </div>
            `);
            return;
        }

        let html = '';
        drafts.forEach(function(draft) {
            const previewContent = stripHtml(draft.content).substring(0, 100);
            const lastModified = formatDate(draft.updatedAt);

            html += `
                <div class="card mb-3" style="cursor: pointer;" onclick="loadDraft(${draft.draftId})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title">${draft.title || '(제목 없음)'}</h6>
                                <p class="card-text text-muted">${previewContent}${previewContent.length >= 100 ? '...' : ''}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${lastModified}
                                </small>
                            </div>
                            <div class="ml-3">
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="event.stopPropagation(); deleteDraft(${draft.draftId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        $('#draftList').html(html);
    }

    // 임시저장 불러오기
    function loadDraft(draftId) {
        if (hasContentChanged() && !confirm('현재 작성 중인 내용이 있습니다. 임시저장을 불러오시겠습니까?')) {
            return;
        }

        $.ajax({
            url: `/api/community/draft/${draftId}`,
            type: 'GET',
            success: function(response) {
                if (response.success && response.draft) {
                    const draft = response.draft;

                    $('#title').val(draft.title || '');
                    $('#summernote').summernote('code', draft.content || '');
                    $('#categoryId').val(draft.categoryId || '');

                    currentDraftId = draft.draftId;
                    lastSavedData = getCurrentFormData();

                    $('#draftModal').modal('hide');
                    showToast('임시저장을 불러왔습니다.', 'success');
                } else {
                    showToast('임시저장을 불러올 수 없습니다.', 'error');
                }
            },
            error: function() {
                showToast('임시저장을 불러오는 중 오류가 발생했습니다.', 'error');
            }
        });
    }

    // 임시저장 삭제
    function deleteDraft(draftId) {
        if (!confirm('이 임시저장을 삭제하시겠습니까?')) {
            return;
        }

        $.ajax({
            url: `/api/community/draft/${draftId}`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    loadDraftList();
                    showToast('임시저장이 삭제되었습니다.', 'success');
                } else {
                    showToast('삭제에 실패했습니다.', 'error');
                }
            },
            error: function() {
                showToast('삭제 중 오류가 발생했습니다.', 'error');
            }
        });
    }

    // 유틸리티 함수들
    function getCurrentFormData() {
        return {
            title: $('#title').val().trim(),
            content: $('#summernote').summernote('code'),
            categoryId: $('#categoryId').val()
        };
    }

    function hasContentChanged() {
        const currentData = getCurrentFormData();
        return (
            currentData.title !== (lastSavedData.title || '') ||
            currentData.content !== (lastSavedData.content || '') ||
            currentData.categoryId !== (lastSavedData.categoryId || '')
        );
    }

    function updateLastSavedData() {
        // 실시간으로 현재 데이터를 추적
    }

    function showDraftStatus(type, text) {
        const statusEl = $('#draftStatus');
        const textEl = $('#draftStatusText');

        statusEl.removeClass('saving saved error').addClass(type);

        let iconHtml = '';
        if (type === 'saving') {
            iconHtml = '<i class="fas fa-spinner fa-spin me-1"></i>';
        } else if (type === 'saved') {
            iconHtml = '<i class="fas fa-check me-1"></i>';
        } else if (type === 'error') {
            iconHtml = '<i class="fas fa-exclamation-triangle me-1"></i>';
        }

        textEl.html(iconHtml + text);
        statusEl.show();
    }

    function hideDraftStatus() {
        $('#draftStatus').hide();
    }

    function updateLastSavedTime() {
        const now = new Date();
        $('#lastSavedTime').text(`마지막 저장: ${now.toLocaleTimeString()}`);
    }

    function stripHtml(html) {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return '방금 전';
        if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
        if (diff < 86400000) return Math.floor(diff / 3600000) + '시간 전';

        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, -3);
    }

    function showToast(message, type = 'info') {
        const bgClass = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';

        const iconClass = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        }[type] || 'fas fa-info-circle';

        const toast = $(`
            <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 9999">
                <div class="toast show" role="alert">
                    <div class="toast-header ${bgClass} text-white">
                        <i class="${iconClass} me-2"></i>
                        <strong class="me-auto">알림</strong>
                        <button type="button" class="close text-white" onclick="$(this).closest('.toast').parent().remove()">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            </div>
        `);

        $('body').append(toast);

        setTimeout(() => {
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }


    // 브라우저 알림 권한 요청 (선택사항)
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
</script>

</body>
</html>