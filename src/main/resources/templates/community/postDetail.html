<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title} + ' - ê²Œì‹œê¸€ ìƒì„¸'"></title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/board.css}">

    <style>
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .replies {
            margin-left: 30px;
            padding-left: 15px;
            border-left: 2px solid #eee;
        }

        .btn-like, .btn-dislike {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            margin-right: 15px;
        }

        .btn-like.active {
            color: #198754;
        }

        .btn-dislike.active {
            color: #dc3545;
        }

        .post-content img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ê²Œì‹œê¸€ ìƒì„¸</h1>
        <a th:href="@{/board/category/{categoryId}(categoryId=${post.categoryId})}" class="btn btn-outline-secondary">ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-secondary me-2" th:text="${post.categoryName}"></span>
                    <h2 class="d-inline" th:text="${post.title}"></h2>
                    <span class="badge bg-danger ms-2" th:if="${post.isNotice}">ê³µì§€</span>
                </div>
            </div>
            <div class="text-muted small mt-2">
                <span th:text="${post.nickname}"></span> |
                <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span> |
                ì¡°íšŒìˆ˜: <span th:text="${post.viewCount}"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="post-content" th:utext="${post.content}"></div>

            <!-- ì²¨ë¶€íŒŒì¼ ëª©ë¡ -->
            <div class="mt-4" th:if="${not #lists.isEmpty(attachments)}">
                <h5>ì²¨ë¶€íŒŒì¼</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item" th:each="attachment : ${attachments}">
                        <a th:href="@{/board/attachment/{attachmentId}(attachmentId=${attachment.attachmentId})}"
                           th:text="${attachment.filename}"></a>
                        <span class="text-muted" th:text="'(' + ${#numbers.formatDecimal(attachment.fileSize / 1024, 0, 'COMMA', 2, 'POINT')} + ' KB)'"></span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-end">
                <!-- ì‘ì„±ìë§Œ ë³´ì´ëŠ” ë²„íŠ¼ -->
                <th:block th:if="${post.userId == currentUserId}">
                    <a th:href="@{/board/post/{postId}/edit(postId=${post.postId})}" class="btn btn-outline-primary me-2">ìˆ˜ì •</a>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="deletePost()">ì‚­ì œ</button>
                </th:block>
            </div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">ëŒ“ê¸€ <span class="text-muted" th:text="${post.commentCount}"></span></h5>
        </div>
        <div class="card-body">
            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <div class="mb-4">
                <textarea id="commentContent" class="form-control mb-2" rows="3" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                <div class="d-flex justify-content-end">
                    <button id="addComment" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </div>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div id="commentList">
                <!-- JavaScriptë¡œ ëŒ“ê¸€ ë¡œë“œ -->
            </div>
        </div>
    </div>
</div>

<!-- ì‚­ì œ í¼ (íˆë“ ) -->
<form id="deleteForm" th:action="@{/board/post/{postId}/delete(postId=${post.postId})}" method="post"></form>

<!-- ëŒ“ê¸€ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
    const postId = [[${post.postId}]];
    const currentUserId = [[${currentUserId}]];

    $(document).ready(function() {
        // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
        loadComments();

        // ê²Œì‹œê¸€ ì‚­ì œ í•¨ìˆ˜
        window.deletePost = function() {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                $('#deleteForm').submit();
            }
        };

        // ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ í´ë¦­
        $('#addComment').click(function() {
            const content = $('#commentContent').val();

            if (!content.trim()) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: postId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        $('#commentContent').val('');
                        loadComments();
                    }
                }
            });
        });

        // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadComments() {
            $.ajax({
                url: `/api/board/comments/${postId}`,
                type: 'GET',
                success: function(response) {
                    renderComments(response.comments);
                }
            });
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComments(comments) {
            let html = '';

            if (comments.length === 0) {
                html = '<div class="text-center py-4">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
            } else {
                comments.forEach(function(comment) {
                    // ë¶€ëª¨ ëŒ“ê¸€ë§Œ ì²˜ë¦¬
                    if (!comment.parentId) {
                        html += renderComment(comment);

                        // ëŒ€ëŒ“ê¸€ ì²˜ë¦¬
                        if (comment.childComments && comment.childComments.length > 0) {
                            html += '<div class="replies">';
                            comment.childComments.forEach(function(reply) {
                                html += renderComment(reply);
                            });
                            html += '</div>';
                        }
                    }
                });
            }

            $('#commentList').html(html);
        }

        // ê°œë³„ ëŒ“ê¸€ ë Œë”ë§
        function renderComment(comment) {
            const isOwner = comment.userId == currentUserId;

            return `
                    <div class="comment" data-id="${comment.commentId}">
                        <div class="comment-header">
                            <span class="fw-bold">${comment.nickname}</span>
                            <span class="text-muted small">${formatDate(comment.createdAt)}</span>
                        </div>
                        <div class="comment-content">
                            ${comment.content}
                        </div>
                        <div class="comment-actions">
                            <div>
                                <button class="btn-reply">ë‹µê¸€</button>
                                ${isOwner ? `
                                    <button class="btn-edit">ìˆ˜ì •</button>
                                    <button class="btn-delete">ì‚­ì œ</button>
                                ` : ''}
                            </div>
                            <div class="like-buttons">
                                <button class="btn-like ${comment.isLiked ? 'active' : ''}" data-comment-id="${comment.commentId}">
                                    ğŸ‘ <span>${comment.likeCount || 0}</span>
                                </button>
                                <button class="btn-dislike ${comment.isDisliked ? 'active' : ''}" data-comment-id="${comment.commentId}">
                                    ğŸ‘ <span>${comment.dislikeCount || 0}</span>
                                </button>
                            </div>
                        </div>
                        <div class="reply-form mt-3" style="display:none;">
                            <textarea class="form-control mb-2" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-primary submit-reply">ë“±ë¡</button>
                                <button class="btn btn-sm btn-secondary ms-2 cancel-reply">ì·¨ì†Œ</button>
                            </div>
                        </div>
                        <div class="edit-form mt-3" style="display:none;">
                            <textarea class="form-control mb-2" rows="2">${comment.content}</textarea>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-primary submit-edit">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-secondary ms-2 cancel-edit">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                `;
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // ë‹µê¸€ í¼ í† ê¸€
        $(document).on('click', '.btn-reply', function() {
            const commentDiv = $(this).closest('.comment');
            commentDiv.find('.reply-form').toggle();
            commentDiv.find('.edit-form').hide();
        });

        // ë‹µê¸€ ì·¨ì†Œ
        $(document).on('click', '.cancel-reply', function() {
            $(this).closest('.reply-form').hide();
        });

        // ìˆ˜ì • í¼ í† ê¸€
        $(document).on('click', '.btn-edit', function() {
            const commentDiv = $(this).closest('.comment');
            commentDiv.find('.edit-form').toggle();
            commentDiv.find('.reply-form').hide();
        });

        // ìˆ˜ì • ì·¨ì†Œ
        $(document).on('click', '.cancel-edit', function() {
            $(this).closest('.edit-form').hide();
        });

        // ë‹µê¸€ ì‘ì„±
        $(document).on('click', '.submit-reply', function() {
            const commentDiv = $(this).closest('.comment');
            const parentId = commentDiv.data('id');
            const content = commentDiv.find('.reply-form textarea').val();

            if (!content.trim()) {
                alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: postId,
                    parentId: parentId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        commentDiv.find('.reply-form textarea').val('');
                        commentDiv.find('.reply-form').hide();
                        loadComments();
                    }
                }
            });
        });

        // ëŒ“ê¸€ ìˆ˜ì •
        $(document).on('click', '.submit-edit', function() {
            const commentDiv = $(this).closest('.comment');
            const commentId = commentDiv.data('id');
            const content = commentDiv.find('.edit-form textarea').val();

            if (!content.trim()) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    commentId: commentId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        commentDiv.find('.edit-form').hide();
                        loadComments();
                    }
                }
            });
        });

        // ëŒ“ê¸€ ì‚­ì œ
        $(document).on('click', '.btn-delete', function() {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const commentDiv = $(this).closest('.comment');
                const commentId = commentDiv.data('id');

                $.ajax({
                    url: `/api/board/comment/delete/${commentId}`,
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            loadComments();
                        }
                    }
                });
            }
        });

        // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­
        $(document).on('click', '.btn-like', function() {
            const commentId = $(this).data('comment-id');
            toggleLike(commentId, true);
        });

        // ì‹«ì–´ìš” ë²„íŠ¼ í´ë¦­
        $(document).on('click', '.btn-dislike', function() {
            const commentId = $(this).data('comment-id');
            toggleLike(commentId, false);
        });

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” í† ê¸€
        function toggleLike(commentId, isLike) {
            $.ajax({
                url: '/api/board/comment/like',
                type: 'POST',
                data: {
                    commentId: commentId,
                    isLike: isLike
                },
                success: function(response) {
                    if (response.success) {
                        loadComments();
                    }
                }
            });
        }
    });
</script>
</body>
</html>