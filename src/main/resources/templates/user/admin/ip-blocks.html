<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="UTF-8">
	<title>IP 차단 로그</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		:root {
			--primary-color: #6366f1;
			--primary-dark: #4f46e5;
			--secondary-color: #f1f5f9;
			--danger-color: #ef4444;
			--success-color: #10b981;
			--warning-color: #f59e0b;
			--text-primary: #0f172a;
			--text-secondary: #64748b;
			--border-color: #e2e8f0;
			--card-bg: #ffffff;
			--sidebar-bg: #1e293b;
			--gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			--gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
			--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
			--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
			--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			line-height: 1.6;
			color: var(--text-primary);
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 2rem;
		}

		.header {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 16px;
			padding: 2rem;
			margin-bottom: 2rem;
			box-shadow: var(--shadow-xl);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.header h1 {
			font-size: 2.5rem;
			font-weight: 700;
			background: var(--gradient-primary);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-align: center;
			margin-bottom: 0.5rem;
		}

		.header-subtitle {
			text-align: center;
			color: var(--text-secondary);
			font-size: 1.1rem;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 1.5rem;
			margin-bottom: 2rem;
		}

		.stat-card {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 12px;
			padding: 1.5rem;
			box-shadow: var(--shadow-md);
			border: 1px solid rgba(255, 255, 255, 0.2);
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		.stat-card:hover {
			transform: translateY(-2px);
			box-shadow: var(--shadow-lg);
		}

		.stat-icon {
			width: 48px;
			height: 48px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
			margin-bottom: 1rem;
		}

		.stat-icon.danger { background: linear-gradient(135deg, #fee2e2, #fecaca); color: var(--danger-color); }
		.stat-icon.success { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: var(--success-color); }
		.stat-icon.warning { background: linear-gradient(135deg, #fef3c7, #fde68a); color: var(--warning-color); }
		.stat-icon.primary { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: var(--primary-color); }

		.stat-value {
			font-size: 2rem;
			font-weight: 700;
			color: var(--text-primary);
			margin-bottom: 0.25rem;
		}

		.stat-label {
			color: var(--text-secondary);
			font-size: 0.875rem;
			font-weight: 500;
		}

		.content-grid {
			display: grid;
			grid-template-columns: 1fr 400px;
			gap: 2rem;
			margin-bottom: 2rem;
		}

		@media (max-width: 1200px) {
			.content-grid {
				grid-template-columns: 1fr;
			}
		}

		.table-section {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 16px;
			overflow: hidden;
			box-shadow: var(--shadow-xl);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.section-header {
			padding: 1.5rem 2rem;
			border-bottom: 1px solid var(--border-color);
			background: rgba(248, 250, 252, 0.8);
		}

		.section-title {
			font-size: 1.25rem;
			font-weight: 600;
			color: var(--text-primary);
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.table-container {
			overflow-x: auto;
			max-height: 600px;
			overflow-y: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			background: rgba(248, 250, 252, 0.8);
			padding: 1rem;
			font-weight: 600;
			color: var(--text-primary);
			text-align: left;
			font-size: 0.875rem;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		td {
			padding: 1rem;
			border-bottom: 1px solid var(--border-color);
			font-size: 0.875rem;
			color: var(--text-secondary);
		}

		tbody tr {
			transition: background-color 0.2s ease;
		}

		tbody tr:hover {
			background-color: rgba(99, 102, 241, 0.05);
		}

		.ip-cell {
			font-family: 'Monaco', 'Consolas', monospace;
			font-weight: 600;
			color: var(--text-primary);
		}

		.country-cell {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.country-flag {
			width: 20px;
			height: 15px;
			border-radius: 2px;
			background: var(--border-color);
		}

		.bot-badge {
			display: inline-flex;
			align-items: center;
			padding: 0.25rem 0.75rem;
			border-radius: 9999px;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.bot-badge.bot {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger-color);
		}

		.bot-badge.browser {
			background: rgba(16, 185, 129, 0.1);
			color: var(--success-color);
		}

		.time-cell {
			color: var(--text-secondary);
			font-size: 0.8rem;
		}

		.charts-section {
			display: flex;
			flex-direction: column;
			gap: 2rem;
		}

		.chart-card {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 16px;
			padding: 1.5rem;
			box-shadow: var(--shadow-xl);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.chart-title {
			font-size: 1.125rem;
			font-weight: 600;
			color: var(--text-primary);
			margin-bottom: 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.chart-container {
			position: relative;
			height: 250px;
		}

		.loading {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 200px;
			color: var(--text-secondary);
		}

		.spinner {
			width: 24px;
			height: 24px;
			border: 2px solid var(--border-color);
			border-top: 2px solid var(--primary-color);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-right: 0.5rem;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.status-indicator {
			position: fixed;
			top: 2rem;
			right: 2rem;
			padding: 0.75rem 1rem;
			border-radius: 8px;
			font-size: 0.875rem;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			z-index: 1000;
			transition: all 0.3s ease;
		}

		.status-indicator.online {
			background: rgba(16, 185, 129, 0.1);
			color: var(--success-color);
			border: 1px solid rgba(16, 185, 129, 0.2);
		}

		.status-indicator.offline {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger-color);
			border: 1px solid rgba(239, 68, 68, 0.2);
		}

		.pulse {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: currentColor;
			animation: pulse 2s infinite;
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.5; }
		}

		.empty-state {
			text-align: center;
			padding: 3rem;
			color: var(--text-secondary);
		}

		.empty-state i {
			font-size: 3rem;
			margin-bottom: 1rem;
			opacity: 0.5;
		}
	</style>
</head>
<body>
<div class="status-indicator online" id="statusIndicator">
	<div class="pulse"></div>
	실시간 모니터링 중
</div>

<div class="container">
	<div class="header">
		<h1><i class="fas fa-shield-alt"></i> IP 차단 로그</h1>
		<p class="header-subtitle">실시간 보안 모니터링 대시보드</p>
	</div>

	<div class="stats-grid" id="statsGrid">
		<div class="stat-card">
			<div class="stat-icon danger">
				<i class="fas fa-ban"></i>
			</div>
			<div class="stat-value" id="totalBlocked">0</div>
			<div class="stat-label">총 차단된 IP</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon warning">
				<i class="fas fa-robot"></i>
			</div>
			<div class="stat-value" id="botCount">0</div>
			<div class="stat-label">Bot 차단</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon success">
				<i class="fas fa-globe"></i>
			</div>
			<div class="stat-value" id="countryCount">0</div>
			<div class="stat-label">차단 국가</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon primary">
				<i class="fas fa-clock"></i>
			</div>
			<div class="stat-value" id="lastUpdate">-</div>
			<div class="stat-label">마지막 업데이트</div>
		</div>
	</div>

	<div class="content-grid">
		<div class="table-section">
			<div class="section-header">
				<h2 class="section-title">
					<i class="fas fa-list"></i>
					차단된 IP 목록
				</h2>
			</div>
			<div class="table-container">
				<table>
					<thead>
					<tr>
						<th>IP 주소</th>
						<th>국가</th>
						<th>도시</th>
						<th>유저 에이전트</th>
						<th>타입</th>
						<th>차단 시간</th>
					</tr>
					</thead>
					<tbody id="logTableBody">
					<tr>
						<td colspan="6" class="loading">
							<div class="spinner"></div>
							데이터를 불러오는 중...
						</td>
					</tr>
					</tbody>
				</table>
			</div>
		</div>

		<div class="charts-section">
			<div class="chart-card">
				<h3 class="chart-title">
					<i class="fas fa-chart-bar"></i>
					국가별 차단 분포
				</h3>
				<div class="chart-container">
					<canvas id="countryChart"></canvas>
				</div>
			</div>

			<div class="chart-card">
				<h3 class="chart-title">
					<i class="fas fa-chart-pie"></i>
					Bot vs Browser
				</h3>
				<div class="chart-container">
					<canvas id="typeChart"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	let countryChart, typeChart;
	let lastFetchTime = null;

	function updateStats(data) {
		const totalBlocked = data.length;
		const botCount = data.filter(log => log.bot).length;
		const countries = new Set(data.map(log => log.country || 'Unknown')).size;

		document.getElementById('totalBlocked').textContent = totalBlocked.toLocaleString();
		document.getElementById('botCount').textContent = botCount.toLocaleString();
		document.getElementById('countryCount').textContent = countries.toLocaleString();
		document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
	}

	function formatUserAgent(userAgent) {
		if (!userAgent) return 'N/A';
		if (userAgent.length > 50) {
			return userAgent.substring(0, 50) + '...';
		}
		return userAgent;
	}

	function formatTime(timeString) {
		try {
			return new Date(timeString).toLocaleString('ko-KR');
		} catch {
			return timeString;
		}
	}

	async function fetchBlockedIps() {
		try {
			const statusIndicator = document.getElementById('statusIndicator');

			const res = await fetch("/api/admin/blocked-ips");
			const data = await res.json();

			statusIndicator.className = 'status-indicator online';
			statusIndicator.innerHTML = '<div class="pulse"></div>실시간 모니터링 중';

			updateStats(data);

			const tbody = document.getElementById("logTableBody");
			tbody.innerHTML = "";

			if (data.length === 0) {
				tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-shield-alt"></i>
                                <div>차단된 IP가 없습니다</div>
                            </td>
                        </tr>
                    `;
			} else {
				const countryCounts = {};
				let botCount = 0, browserCount = 0;

				data.forEach(log => {
					const row = `
                        <tr>
                            <td class="ip-cell">${log.ip}</td>
                            <td class="country-cell">
                                <div class="country-flag"></div>
                                ${log.country || 'N/A'}
                            </td>
                            <td>${log.city || 'N/A'}</td>
                            <td title="${log.userAgent || 'N/A'}">${formatUserAgent(log.userAgent)}</td>
                            <td>
                                <span class="bot-badge ${log.bot ? 'bot' : 'browser'}">
                                    ${log.bot ? 'Bot' : 'Browser'}
                                </span>
                            </td>
                            <td class="time-cell">${formatTime(log.blockedAt)}</td>
                        </tr>`;
					tbody.insertAdjacentHTML("beforeend", row);

					const country = log.country || "Unknown";
					countryCounts[country] = (countryCounts[country] || 0) + 1;
					log.bot ? botCount++ : browserCount++;
				});

				updateCharts(countryCounts, botCount, browserCount);
			}
		} catch (error) {
			console.error('Failed to fetch blocked IPs:', error);
			const statusIndicator = document.getElementById('statusIndicator');
			statusIndicator.className = 'status-indicator offline';
			statusIndicator.innerHTML = '<div class="pulse"></div>연결 실패';
		}
	}

	function updateCharts(countryCounts, botCount, browserCount) {
		const countries = Object.keys(countryCounts);
		const counts = Object.values(countryCounts);

		// Country Chart
		if (!countryChart) {
			countryChart = new Chart(document.getElementById('countryChart'), {
				type: 'doughnut',
				data: {
					labels: countries,
					datasets: [{
						label: 'Blocked IPs by Country',
						data: counts,
						backgroundColor: [
							'#6366f1', '#8b5cf6', '#06b6d4', '#10b981',
							'#f59e0b', '#ef4444', '#ec4899', '#84cc16'
						],
						borderWidth: 0
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							position: 'bottom',
							labels: {
								padding: 20,
								usePointStyle: true
							}
						}
					}
				}
			});
		} else {
			countryChart.data.labels = countries;
			countryChart.data.datasets[0].data = counts;
			countryChart.update();
		}

		// Type Chart
		if (!typeChart) {
			typeChart = new Chart(document.getElementById('typeChart'), {
				type: 'doughnut',
				data: {
					labels: ['Bot', 'Browser'],
					datasets: [{
						data: [botCount, browserCount],
						backgroundColor: ['#ef4444', '#10b981'],
						borderWidth: 0
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							position: 'bottom',
							labels: {
								padding: 20,
								usePointStyle: true
							}
						}
					}
				}
			});
		} else {
			typeChart.data.datasets[0].data = [botCount, browserCount];
			typeChart.update();
		}
	}

	// 초기 로딩 및 주기적 업데이트
	setInterval(fetchBlockedIps, 5000);
	fetchBlockedIps();
</script>
</body>
</html>