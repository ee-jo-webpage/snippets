<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title} + ' - 게시글 상세'"></title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/board.css}">

    <style>
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .replies {
            margin-left: 30px;
            padding-left: 15px;
            border-left: 2px solid #eee;
        }

        .btn-like, .btn-dislike {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            margin-right: 15px;
        }

        .btn-like.active {
            color: #198754;
        }

        .btn-dislike.active {
            color: #dc3545;
        }

        .post-content img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>게시글 상세</h1>
        <a th:href="@{/board/category/{categoryId}(categoryId=${post.categoryId})}" class="btn btn-outline-secondary">목록으로</a>
    </div>

    <!-- 게시글 상세 -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-secondary me-2" th:text="${post.categoryName}"></span>
                    <h2 class="d-inline" th:text="${post.title}"></h2>
                    <span class="badge bg-danger ms-2" th:if="${post.isNotice}">공지</span>
                </div>
            </div>
            <div class="text-muted small mt-2">
                <span th:text="${post.nickname}"></span> |
                <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span> |
                조회수: <span th:text="${post.viewCount}"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="post-content" th:utext="${post.content}"></div>

            <!-- 첨부파일 목록 -->
            <div class="mt-4" th:if="${not #lists.isEmpty(attachments)}">
                <h5>첨부파일</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item" th:each="attachment : ${attachments}">
                        <a th:href="@{/board/attachment/{attachmentId}(attachmentId=${attachment.attachmentId})}"
                           th:text="${attachment.filename}"></a>
                        <span class="text-muted" th:text="'(' + ${#numbers.formatDecimal(attachment.fileSize / 1024, 0, 'COMMA', 2, 'POINT')} + ' KB)'"></span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-end">
                <!-- 작성자만 보이는 버튼 -->
                <th:block th:if="${post.userId == currentUserId}">
                    <a th:href="@{/board/post/{postId}/edit(postId=${post.postId})}" class="btn btn-outline-primary me-2">수정</a>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="deletePost()">삭제</button>
                </th:block>
            </div>
        </div>
    </div>

    <!-- 댓글 영역 -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">댓글 <span class="text-muted" th:text="${post.commentCount}"></span></h5>
        </div>
        <div class="card-body">
            <!-- 댓글 작성 폼 -->
            <div class="mb-4">
                <textarea id="commentContent" class="form-control mb-2" rows="3" placeholder="댓글을 작성하세요"></textarea>
                <div class="d-flex justify-content-end">
                    <button id="addComment" class="btn btn-primary">등록</button>
                </div>
            </div>

            <!-- 댓글 목록 -->
            <div id="commentList">
                <!-- JavaScript로 댓글 로드 -->
            </div>
        </div>
    </div>
</div>

<!-- 삭제 폼 (히든) -->
<form id="deleteForm" th:action="@{/board/post/{postId}/delete(postId=${post.postId})}" method="post"></form>

<!-- 댓글 스크립트 -->
<script th:inline="javascript">
    const postId = [[${post.postId}]];
    const currentUserId = [[${currentUserId}]];

    $(document).ready(function() {
        // 댓글 목록 로드
        loadComments();

        // 게시글 삭제 함수
        window.deletePost = function() {
            if (confirm('정말 삭제하시겠습니까?')) {
                $('#deleteForm').submit();
            }
        };

        // 댓글 등록 버튼 클릭
        $('#addComment').click(function() {
            const content = $('#commentContent').val();

            if (!content.trim()) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: postId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        $('#commentContent').val('');
                        loadComments();
                    }
                }
            });
        });

        // 댓글 목록 불러오기
        function loadComments() {
            $.ajax({
                url: `/api/board/comments/${postId}`,
                type: 'GET',
                success: function(response) {
                    renderComments(response.comments);
                }
            });
        }

        // 댓글 렌더링
        function renderComments(comments) {
            let html = '';

            if (comments.length === 0) {
                html = '<div class="text-center py-4">첫 번째 댓글을 작성해보세요!</div>';
            } else {
                comments.forEach(function(comment) {
                    // 부모 댓글만 처리
                    if (!comment.parentId) {
                        html += renderComment(comment);

                        // 대댓글 처리
                        if (comment.childComments && comment.childComments.length > 0) {
                            html += '<div class="replies">';
                            comment.childComments.forEach(function(reply) {
                                html += renderComment(reply);
                            });
                            html += '</div>';
                        }
                    }
                });
            }

            $('#commentList').html(html);
        }

        // 개별 댓글 렌더링
        function renderComment(comment) {
            const isOwner = comment.userId == currentUserId;

            return `
                    <div class="comment" data-id="${comment.commentId}">
                        <div class="comment-header">
                            <span class="fw-bold">${comment.nickname}</span>
                            <span class="text-muted small">${formatDate(comment.createdAt)}</span>
                        </div>
                        <div class="comment-content">
                            ${comment.content}
                        </div>
                        <div class="comment-actions">
                            <div>
                                <button class="btn-reply">답글</button>
                                ${isOwner ? `
                                    <button class="btn-edit">수정</button>
                                    <button class="btn-delete">삭제</button>
                                ` : ''}
                            </div>
                            <div class="like-buttons">
                                <button class="btn-like ${comment.isLiked ? 'active' : ''}" data-comment-id="${comment.commentId}">
                                    👍 <span>${comment.likeCount || 0}</span>
                                </button>
                                <button class="btn-dislike ${comment.isDisliked ? 'active' : ''}" data-comment-id="${comment.commentId}">
                                    👎 <span>${comment.dislikeCount || 0}</span>
                                </button>
                            </div>
                        </div>
                        <div class="reply-form mt-3" style="display:none;">
                            <textarea class="form-control mb-2" rows="2" placeholder="답글을 입력하세요"></textarea>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-primary submit-reply">등록</button>
                                <button class="btn btn-sm btn-secondary ms-2 cancel-reply">취소</button>
                            </div>
                        </div>
                        <div class="edit-form mt-3" style="display:none;">
                            <textarea class="form-control mb-2" rows="2">${comment.content}</textarea>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-primary submit-edit">수정</button>
                                <button class="btn btn-sm btn-secondary ms-2 cancel-edit">취소</button>
                            </div>
                        </div>
                    </div>
                `;
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // 답글 폼 토글
        $(document).on('click', '.btn-reply', function() {
            const commentDiv = $(this).closest('.comment');
            commentDiv.find('.reply-form').toggle();
            commentDiv.find('.edit-form').hide();
        });

        // 답글 취소
        $(document).on('click', '.cancel-reply', function() {
            $(this).closest('.reply-form').hide();
        });

        // 수정 폼 토글
        $(document).on('click', '.btn-edit', function() {
            const commentDiv = $(this).closest('.comment');
            commentDiv.find('.edit-form').toggle();
            commentDiv.find('.reply-form').hide();
        });

        // 수정 취소
        $(document).on('click', '.cancel-edit', function() {
            $(this).closest('.edit-form').hide();
        });

        // 답글 작성
        $(document).on('click', '.submit-reply', function() {
            const commentDiv = $(this).closest('.comment');
            const parentId = commentDiv.data('id');
            const content = commentDiv.find('.reply-form textarea').val();

            if (!content.trim()) {
                alert('답글 내용을 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: postId,
                    parentId: parentId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        commentDiv.find('.reply-form textarea').val('');
                        commentDiv.find('.reply-form').hide();
                        loadComments();
                    }
                }
            });
        });

        // 댓글 수정
        $(document).on('click', '.submit-edit', function() {
            const commentDiv = $(this).closest('.comment');
            const commentId = commentDiv.data('id');
            const content = commentDiv.find('.edit-form textarea').val();

            if (!content.trim()) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/api/board/comment/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    commentId: commentId,
                    content: content
                }),
                success: function(response) {
                    if (response.success) {
                        commentDiv.find('.edit-form').hide();
                        loadComments();
                    }
                }
            });
        });

        // 댓글 삭제
        $(document).on('click', '.btn-delete', function() {
            if (confirm('정말 삭제하시겠습니까?')) {
                const commentDiv = $(this).closest('.comment');
                const commentId = commentDiv.data('id');

                $.ajax({
                    url: `/api/board/comment/delete/${commentId}`,
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            loadComments();
                        }
                    }
                });
            }
        });

        // 좋아요 버튼 클릭
        $(document).on('click', '.btn-like', function() {
            const commentId = $(this).data('comment-id');
            toggleLike(commentId, true);
        });

        // 싫어요 버튼 클릭
        $(document).on('click', '.btn-dislike', function() {
            const commentId = $(this).data('comment-id');
            toggleLike(commentId, false);
        });

        // 좋아요/싫어요 토글
        function toggleLike(commentId, isLike) {
            $.ajax({
                url: '/api/board/comment/like',
                type: 'POST',
                data: {
                    commentId: commentId,
                    isLike: isLike
                },
                success: function(response) {
                    if (response.success) {
                        loadComments();
                    }
                }
            });
        }
    });
</script>
</body>
</html>