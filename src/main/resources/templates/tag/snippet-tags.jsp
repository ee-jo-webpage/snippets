<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ïä§ÎãàÌé´ ÌÉúÍ∑∏ Í¥ÄÎ¶¨</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Malgun Gothic', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        .search-bar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: #3498db;
        }

        .snippets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 20px;
        }

        .snippet-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: transform 0.2s ease;
        }

        .snippet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .snippet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .snippet-id {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .snippet-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .snippet-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .snippet-language,
        .snippet-type,
        .snippet-date {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .snippet-language {
            background: #e8f5e9;
            color: #27ae60;
        }

        .snippet-type {
            background: #fff3e0;
            color: #f57c00;
        }

        .snippet-date {
            background: #f3e5f5;
            color: #8e24aa;
        }

        .snippet-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        /* ÌÉúÍ∑∏ Í¥ÄÎ¶¨ ÏòÅÏó≠ */
        .tag-management {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
        }

        .current-tags {
            margin-bottom: 15px;
        }

        .current-tags-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag-remove {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.8;
            font-weight: bold;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .tag-input-container {
            position: relative;
        }

        .tag-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .tag-input:focus {
            border-color: #3498db;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e6ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f1f2f6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .no-tags {
            color: #999;
            font-style: italic;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .snippets-grid {
                grid-template-columns: 1fr;
            }

            .snippet-header {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* ÌîåÎ°úÌåÖ ÏïåÎ¶º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 2000;
        }

        .toast.error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìù Ïä§ÎãàÌé´ ÌÉúÍ∑∏ Í¥ÄÎ¶¨</h1>

    <div class="search-bar">
        <input type="text"
               id="snippetSearch"
               class="search-input"
               placeholder="Ïä§ÎãàÌé´ Í≤ÄÏÉâ (Ï†úÎ™©, ÎÇ¥Ïö©, ÌÉúÍ∑∏...)">
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="snippetsContainer" class="snippets-grid">
        <div class="loading">Ïä§ÎãàÌé´ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>
</div>

<!-- ÌîåÎ°úÌåÖ ÏïåÎ¶º -->
<div id="toast" class="toast"></div>

<script type="text/javascript">

    $(document).ready(function () {
        // Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏
        let allSnippets = [];
        let allTags = [];
        let snippetTags = {}; // snippetId -> tags array

        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        loadInitialData();

        // Í≤ÄÏÉâ Í∏∞Îä•
        $('#snippetSearch').on('input', function () {
            const keyword = $(this).val().toLowerCase();
            filterSnippets(keyword);
        });

        // ÌÉúÍ∑∏ ÏûÖÎ†• Ïù¥Î≤§Ìä∏ (ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî ÏöîÏÜåÏö©)
        $(document).on('input', '.tag-input', function () {
            const input = $(this);
            const keyword = input.val().trim();
            const autocompleteList = input.siblings('.autocomplete-list');

            if (keyword.length > 0) {
                const filteredTags = allTags.filter(tag =>
                    tag.name.toLowerCase().includes(keyword.toLowerCase())
                );
                showAutocomplete(autocompleteList, filteredTags);
            } else {
                autocompleteList.hide();
            }
        });

        // ÌÉúÍ∑∏ ÏûÖÎ†• ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
        $(document).on('keydown', '.tag-input', function (e) {
            const input = $(this);
            const autocompleteList = input.siblings('.autocomplete-list');
            const items = autocompleteList.find('.autocomplete-item');
            const selectedItem = items.filter('.selected');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedItem.length === 0) {
                    items.first().addClass('selected');
                } else {
                    selectedItem.removeClass('selected');
                    const next = selectedItem.next();
                    if (next.length > 0) {
                        next.addClass('selected');
                    } else {
                        items.first().addClass('selected');
                    }
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedItem.length === 0) {
                    items.last().addClass('selected');
                } else {
                    selectedItem.removeClass('selected');
                    const prev = selectedItem.prev();
                    if (prev.length > 0) {
                        prev.addClass('selected');
                    } else {
                        items.last().addClass('selected');
                    }
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedItem.length > 0) {
                    const tagName = selectedItem.text();
                    addTagToSnippet(input, tagName);
                } else {
                    const tagName = input.val().trim();
                    if (tagName) {
                        addTagToSnippet(input, tagName);
                    }
                }
            } else if (e.key === 'Escape') {
                autocompleteList.hide();
            }
        });

        // ÏûêÎèôÏôÑÏÑ± ÌÅ¥Î¶≠
        $(document).on('click', '.autocomplete-item', function () {
            const tagName = $(this).text();
            const input = $(this).closest('.tag-input-container').find('.tag-input');
            addTagToSnippet(input, tagName);
        });

        // ÌÉúÍ∑∏ Ï†úÍ±∞
        $(document).on('click', '.tag-remove', function (e) {
            e.preventDefault();
            const tagElement = $(this).closest('.tag-item');
            const tagName = tagElement.text().replace('√ó', '').trim();
            const snippetId = $(this).closest('.snippet-card').data('snippet-id');

            removeTagFromSnippet(snippetId, tagName, tagElement);
        });

        // Ìï®ÏàòÎì§
        function loadInitialData() {
            // Î™®Îì† ÌÉúÍ∑∏ Î°úÎìú
            $.ajax({
                url: '/api/tag',
                method: 'GET',
                success: function (tags) {
                    console.log('Î™®Îì† ÌÉúÍ∑∏ Î°úÎìú ÏÑ±Í≥µ:', tags);
                    allTags = tags || [];
                },
                error: function (xhr) {
                    console.error('ÌÉúÍ∑∏ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', xhr.status);
                    allTags = [];
                    showError('ÌÉúÍ∑∏ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                },
                complete: function () {
                    // ÌÉúÍ∑∏ Î°úÎìú ÌõÑ Ïä§ÎãàÌé´ Î°úÎìú
                    loadSnippets();
                }
            });
        }

        function loadSnippets() {
            console.log('===== Ïä§ÎãàÌé´ Î°úÎìú ÏãúÏûë =====');

            $.ajax({
                url: '/api/snippet',
                method: 'GET',
                success: function(snippets) {
                    console.log('Ïä§ÎãàÌé´ API Ìò∏Ï∂ú ÏÑ±Í≥µ');

                    // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏
                    console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ:', typeof snippets);
                    console.log('ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù∏Í∞Ä?', Array.isArray(snippets));

                    // ÏùëÎãµÏóêÏÑú Î∞∞Ïó¥ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
                    if (!Array.isArray(snippets)) {
                        console.log('ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãò. Î≥ÄÌôò ÏãúÎèÑ...');
                        if (snippets && typeof snippets === 'object') {
                            if (snippets.content && Array.isArray(snippets.content)) {
                                snippets = snippets.content;
                            }
                        }
                    }

                    // Îç∞Ïù¥ÌÑ∞ ÏÉòÌîå ÌôïÏù∏
                    if (Array.isArray(snippets) && snippets.length > 0) {
                        console.log('Ï≤´ Î≤àÏß∏ Ïä§ÎãàÌé´ Íµ¨Ï°∞:', snippets[0]);
                    }

                    // ÌïÑÎìú Ï†ïÍ∑úÌôî Î∞è Ïú†Ìö®Ìïú Ïä§ÎãàÌé´ ÌïÑÌÑ∞ÎßÅ
                    allSnippets = [];
                    if (Array.isArray(snippets)) {
                        // Í∞ÑÎã®Ìûà ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©
                        allSnippets = snippets.filter(snippet => snippet !== null && snippet !== undefined);

                        // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌï¥ Ï≤´ Î™á Í∞ú Ïä§ÎãàÌé´Ïùò ID Ï∂úÎ†•
                        allSnippets.slice(0, 3).forEach((snippet, index) => {
                            console.log(`Ïä§ÎãàÌé´ ${index}Ïùò ID(snippetId): ${snippet.snippetId}`);
                        });
                    }

                    console.log('Ï≤òÎ¶¨Îêú Ïä§ÎãàÌé´ Ïàò:', allSnippets.length);

                    // ÌïÑÌÑ∞ÎßÅ ÌõÑÏóêÎèÑ Ïä§ÎãàÌé´Ïù¥ ÏóÜÏúºÎ©¥ ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                    if (allSnippets.length === 0) {
                        console.log('Ïä§ÎãàÌé´Ïù¥ ÏóÜÏñ¥ ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.');
                        allSnippets = getDummySnippets();
                    }

                    // ÌÉúÍ∑∏ Î°úÎìú ÏãúÏûë
                    loadSnippetTags();
                },
                error: function(xhr, status, error) {
                    console.error('Ïä§ÎãàÌé´ Î°úÎìú Ïã§Ìå®:', error);
                    console.log('ÏóêÎü¨ ÏùëÎãµ:', xhr.responseText);

                    console.log('ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©');
                    allSnippets = getDummySnippets();

                    // ÌÉúÍ∑∏ Î°úÎìú ÏãúÏûë
                    loadSnippetTags();
                }
            });
        }

        // ÌÉúÍ∑∏ Î°úÎìú Ìï®Ïàò
        function loadSnippetTags(focusSnippetId) {
            console.log("Î™®Îì† Ïä§ÎãàÌé´ ÌÉúÍ∑∏ Î°úÎìú ÏãúÏûë");
            if (!allSnippets || allSnippets.length === 0) {
                console.log('Î°úÎìúÌï† Ïä§ÎãàÌé´Ïù¥ ÏóÜÏäµÎãàÎã§.');
                displaySnippets([], focusSnippetId);
                return;
            }

            console.log('Ïä§ÎãàÌé´ ÌÉúÍ∑∏ Î°úÎìú ÏãúÏûë - Ï¥ù Ïä§ÎãàÌé´ Ïàò:', allSnippets.length);

            let loaded = 0;
            const totalSnippets = allSnippets.length;

            // Î™®Îì† Ïä§ÎãàÌé´Ïùò ÌÉúÍ∑∏ Ï¥àÍ∏∞Ìôî
            allSnippets.forEach(snippet => {
                const snippetId = snippet.snippetId;
                console.log(`Ïä§ÎãàÌé´ ÌÉúÍ∑∏ Ï¥àÍ∏∞Ìôî, ID: ${snippetId}`);
                snippetTags[snippetId] = [];
            });

            // ÌÉúÍ∑∏ Î°úÎìú
            allSnippets.forEach((snippet, index) => {
                const snippetId = snippet.snippetId;
                console.log(`Ïä§ÎãàÌé´ ${index}Ïùò ÌÉúÍ∑∏ Î°úÎìú, ID: ${snippetId}`);

                if (!snippetId) {
                    console.error(`Ïä§ÎãàÌé´ ${index}Ïóê Ïú†Ìö®Ìïú IDÍ∞Ä ÏóÜÏäµÎãàÎã§:`, snippet);
                    loaded++;
                    checkAllLoaded();
                    return;
                }

                const apiUrl = '/api/tag/snippets/' + snippetId;
                console.log('ÌÉúÍ∑∏ API URL:', apiUrl);

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    success: function(tags) {
                        console.log('Ïä§ÎãàÌé´ ID - '+snippetId+'Ïùò ÌÉúÍ∑∏ Î°úÎìú ÏÑ±Í≥µ:', tags);
                        if (Array.isArray(tags)) {
                            snippetTags[snippetId] = tags;
                        } else {
                            console.warn(`Ïä§ÎãàÌé´ ID ${snippetId}Ïùò ÌÉúÍ∑∏ ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãò:`, tags);
                            snippetTags[snippetId] = [];
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error(`Ïä§ÎãàÌé´ ID ${snippetId}Ïùò ÌÉúÍ∑∏ Î°úÎìú Ïã§Ìå®:`, {
                            status: xhr.status,
                            error: error
                        });
                        snippetTags[snippetId] = [];
                    },
                    complete: function() {
                        loaded++;
                        console.log(`ÌÉúÍ∑∏ Î°úÎìú ÏßÑÌñâ ÏÉÅÌô©: ${loaded}/${totalSnippets}`);
                        checkAllLoaded();
                    }
                });
            });

            // Î™®Îì† ÌÉúÍ∑∏ Î°úÎìú ÏôÑÎ£å ÌôïÏù∏
            function checkAllLoaded() {
                if (loaded >= totalSnippets) {
                    console.log('Î™®Îì† Ïä§ÎãàÌé´Ïùò ÌÉúÍ∑∏ Î°úÎìú ÏôÑÎ£å');
                    displaySnippets(allSnippets, focusSnippetId);
                }
            }

            // ÏïàÏ†ÑÏû•Ïπò
            setTimeout(function() {
                if (loaded < totalSnippets) {
                    console.warn(`ÌÉúÍ∑∏ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ: ${loaded}/${totalSnippets} ÏôÑÎ£å`);
                    displaySnippets(allSnippets, focusSnippetId);
                }
            }, 5000);
        }

        // ÎçîÎØ∏ Ïä§ÎãàÌé´ Îç∞Ïù¥ÌÑ∞
        function getDummySnippets() {
            const dummySnippets = [
                {
                    snippetId: 1,
                    title: 'JavaScript Î∞∞Ïó¥ Îßµ',
                    content: 'const numbers = [1, 2, 3, 4, 5];\nconst doubled = numbers.map(num => num * 2);',
                    language: 'javascript',
                    type: 'code',
                    createdAt: '2023-02-01',
                    memo: 'JavaScript Î∞∞Ïó¥ Îßµ Ìï®Ïàò ÏòàÏ†ú'
                },
                {
                    snippetId: 2,
                    title: 'React Hook ÏòàÏ†ú',
                    content: 'import React, { useState } from "react";\n\nfunction Counter() {\n  const [count, setCount] = useState(0);\n  return <div>{count}</div>;\n}',
                    language: 'jsx',
                    type: 'code',
                    createdAt: '2023-02-03',
                    memo: 'React useState ÌõÖ ÏÇ¨Ïö©Î≤ï'
                },
                {
                    snippetId: 3,
                    title: 'Date Ìè¨Îß∑ÌåÖ',
                    content: 'function formatDate(date) {\n  return date.toISOString().split("T")[0];\n}',
                    language: 'javascript',
                    type: 'code',
                    createdAt: '2023-02-05',
                    memo: 'ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò'
                }
            ];

            console.log('ÎçîÎØ∏ Ïä§ÎãàÌé´ ÏÉùÏÑ±:', dummySnippets.length);
            return dummySnippets;
        }

        // Ïä§ÎãàÌé´ ÌëúÏãú Ìï®Ïàò
        function displaySnippets(snippets, focusSnippetId) {
            const container = $('#snippetsContainer');
            container.empty();

            if (snippets.length === 0) {
                container.html('<div class="loading">ÌëúÏãúÌï† Ïä§ÎãàÌé´Ïù¥ ÏóÜÏäµÎãàÎã§.</div>');
                return;
            }

            snippets.forEach(snippet => {
                const snippetCard = createSnippetCard(snippet);
                container.append(snippetCard);
            });

            // Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï (ÏßÄÏ†ïÎêú Ïä§ÎãàÌé´ IDÍ∞Ä ÏûàÎäî Í≤ΩÏö∞)
            if (focusSnippetId) {
                console.log(`ÏßÄÏ†ïÎêú Ïä§ÎãàÌé´ ID ${focusSnippetId}Î°ú Ìè¨Ïª§Ïä§ Ïù¥Îèô ÏãúÎèÑ`);

                // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏùÑ ÎëêÍ≥† Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï (DOMÏù¥ ÏôÑÏ†ÑÌûà Î†åÎçîÎßÅÎêú ÌõÑ)
                setTimeout(function() {
                    const card = $(`.snippet-card[data-snippet-id="${focusSnippetId}"]`);
                    if (card.length > 0) {
                        console.log(`Ïä§ÎãàÌé´ ID ${focusSnippetId}Ïùò Ïπ¥ÎìúÎ•º Ï∞æÏùå`);

                        // ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
                        const inputField = card.find('.tag-input');
                        if (inputField.length > 0) {
                            // Ïπ¥ÎìúÍ∞Ä ÌôîÎ©¥Ïóê Î≥¥Ïù¥ÎèÑÎ°ù Ïä§ÌÅ¨Î°§
                            $('html, body').animate({
                                scrollTop: card.offset().top - 100 // ÏÉÅÎã®ÏóêÏÑú 100px ÏúÑÏπòÏóê Ïä§ÌÅ¨Î°§
                            }, 300);

                            // Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï
                            inputField.focus();
                            console.log(`Ïä§ÎãàÌé´ ID ${focusSnippetId}Ïùò ÌÉúÍ∑∏ ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï ÏôÑÎ£å`);
                        } else {
                            console.warn(`Ïä§ÎãàÌé´ ID ${focusSnippetId}Ïùò ÌÉúÍ∑∏ ÏûÖÎ†• ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå`);
                        }
                    } else {
                        console.warn(`Ïä§ÎãàÌé´ ID ${focusSnippetId}Ïùò Ïπ¥ÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå`);
                    }
                }, 300);
            }
        }

        // Ïä§ÎãàÌé´ Ïπ¥Îìú ÏÉùÏÑ± Ìï®Ïàò
        function createSnippetCard(snippet) {
            const snippetId = snippet.snippetId;
            const tags = snippetTags[snippetId] || [];

            // HTML Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
            let cardHtml = '<div class="snippet-card" data-snippet-id="' + snippetId + '">';
            cardHtml += '<div class="snippet-header">';
            cardHtml += '<div class="snippet-snippetId">ID: ' + snippetId + '</div>';
            cardHtml += '</div>';
            cardHtml += '<div class="snippet-title">' + (snippet.title || snippet.memo || 'Ï†úÎ™© ÏóÜÏùå') + '</div>';
            cardHtml += '<div class="snippet-meta">';

            if (snippet.language) {
                cardHtml += '<span class="snippet-language">' + snippet.language + '</span>';
            }
            if (snippet.type) {
                cardHtml += '<span class="snippet-type">' + snippet.type + '</span>';
            }
            if (snippet.createdAt) {
                cardHtml += '<span class="snippet-date">' + snippet.createdAt + '</span>';
            }

            cardHtml += '</div>';
            cardHtml += '<div class="snippet-content">' + (snippet.content || 'ÎÇ¥Ïö© ÏóÜÏùå') + '</div>';
            cardHtml += '<div class="tag-management">';
            cardHtml += '<div class="current-tags">';
            cardHtml += '<div class="current-tags-label">ÌòÑÏû¨ ÌÉúÍ∑∏:</div>';
            cardHtml += '<div class="tag-container" data-snippet-id="' + snippetId + '">';

            if (tags.length === 0) {
                cardHtml += '<span class="no-tags">ÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</span>';
            }

            cardHtml += '</div>';
            cardHtml += '</div>';
            cardHtml += '<div class="tag-input-container">';
            cardHtml += '<input type="text" class="tag-input" placeholder="ÌÉúÍ∑∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† ÏóîÌÑ∞Î•º ÎàÑÎ•¥ÏÑ∏Ïöî..." data-snippet-id="' + snippetId + '">';
            cardHtml += '<div class="autocomplete-list"></div>';
            cardHtml += '</div>';
            cardHtml += '</div>';
            cardHtml += '</div>';

            const card = $(cardHtml);

            // ÌÉúÍ∑∏ ÌëúÏãú
            const tagContainer = card.find('.tag-container');
            if (tags.length > 0) {
                tagContainer.empty();
                tags.forEach(tag => {
                    const tagElement = $('<span class="tag-item">' + tag.name + '<span class="tag-remove">&times;</span></span>');
                    tagContainer.append(tagElement);
                });
            }

            return card;
        }

        // ÏûêÎèôÏôÑÏÑ± ÌëúÏãú Ìï®Ïàò
        function showAutocomplete(autocompleteList, tags) {
            autocompleteList.empty();

            if (tags.length > 0) {
                tags.forEach(tag => {
                    const item = $('<div class="autocomplete-item">' + tag.name + '</div>');
                    autocompleteList.append(item);
                });
                autocompleteList.show();
            } else {
                autocompleteList.hide();
            }
        }

        // ÌÉúÍ∑∏ Ï∂îÍ∞Ä Ìï®Ïàò
        function addTagToSnippet(input, tagName) {
            const snippetId = input.data('snippet-id');
            console.log(`ÌÉúÍ∑∏ Ï∂îÍ∞Ä ÏãúÎèÑ: Ïä§ÎãàÌé´ ID=${snippetId}, ÌÉúÍ∑∏Î™Ö=${tagName}`);

            if (!snippetId) {
                console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïä§ÎãàÌé´ ID:', snippetId);
                showToast('Ïä§ÎãàÌé´ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            if (!tagName || tagName.trim() === '') {
                showToast('ÌÉúÍ∑∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            const currentTags = snippetTags[snippetId] || [];
            console.log(`ÌòÑÏû¨ ÌÉúÍ∑∏ Î™©Î°ù (Ïä§ÎãàÌé´ ${snippetId}):`, currentTags);

            const alreadyExists = currentTags.some(tag =>
                tag.name.toLowerCase() === tagName.toLowerCase()
            );

            if (alreadyExists) {
                showToast('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú ÌÉúÍ∑∏ÏûÖÎãàÎã§.', 'error');
                input.val('');
                input.siblings('.autocomplete-list').hide();
                return;
            }

            console.log('ÌÉúÍ∑∏ ÏÉùÏÑ± API Ìò∏Ï∂ú: '+ tagName);
            $.ajax({
                url: '/api/tag',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({name: tagName}),
                success: function (tag) {
                    console.log(`ÌÉúÍ∑∏ ÏÉùÏÑ± ÏÑ±Í≥µ:`, tag);
                    addTagToSnippetAPI(snippetId, tag);
                },
                error: function (xhr, status, error) {
                    console.error(`ÌÉúÍ∑∏ ÏÉùÏÑ± Ïã§Ìå®:`, {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error,
                        response: xhr.responseText
                    });

                    if (xhr.status === 409) {
                        console.log('ÌÉúÍ∑∏Í∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï®. Í∏∞Ï°¥ ÌÉúÍ∑∏ ÏÇ¨Ïö©:', xhr.responseJSON);
                        const existingTag = xhr.responseJSON;
                        addTagToSnippetAPI(snippetId, existingTag);
                    } else {
                        showToast('ÌÉúÍ∑∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                    }
                }
            });

            input.val('');
            input.siblings('.autocomplete-list').hide();
        }

        // Ïä§ÎãàÌé´Ïóê ÌÉúÍ∑∏ Ï∂îÍ∞Ä API Ìò∏Ï∂ú Ìï®Ïàò
        function addTagToSnippetAPI(snippetId, tag) {
            if (!tag || !tag.tagId) {
                console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌÉúÍ∑∏:', tag);
                showToast('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌÉúÍ∑∏ÏûÖÎãàÎã§.', 'error');
                return;
            }

            const apiUrl = '/api/tag/snippet/' + snippetId + '/tags/' + tag.tagId;
            console.log(`ÌÉúÍ∑∏ Ï∂îÍ∞Ä API Ìò∏Ï∂ú: ${apiUrl}`, {snippetId, tagId: tag.tagId});

            $.ajax({
                url: apiUrl,
                method: 'POST',
                success: function (response) {
                    console.log(`ÌÉúÍ∑∏ Ï∂îÍ∞Ä ÏÑ±Í≥µ:`, response);
                    showToast('ÌÉúÍ∑∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§. Ïä§ÎãàÌé´ÏùÑ Îã§Ïãú Î°úÎìúÌï©ÎãàÎã§...');
                    reloadAllSnippets(snippetId);
                },
                error: function (xhr, status, error) {
                    console.error(`ÌÉúÍ∑∏ Ï∂îÍ∞Ä Ïã§Ìå®:`, {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error,
                        response: xhr.responseText,
                        apiUrl: apiUrl
                    });
                    showToast('ÌÉúÍ∑∏ Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            });
        }

        // ÌÉúÍ∑∏ Ï†úÍ±∞ Ìï®Ïàò
        function removeTagFromSnippet(snippetId, tagName, tagElement) {
            const tag = (snippetTags[snippetId] || []).find(t => t.name === tagName);
            if (!tag) {
                showToast('ÌÉúÍ∑∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const apiUrl = '/api/tag/snippets/' + snippetId + '/tags/' + tag.tagId;
            console.log(`ÌÉúÍ∑∏ Ï†úÍ±∞ API Ìò∏Ï∂ú: ${apiUrl}`, {snippetId, tagId: tag.tagId});

            $.ajax({
                url: apiUrl,
                method: 'DELETE',
                success: function () {
                    showToast('ÌÉúÍ∑∏Í∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§. Ïä§ÎãàÌé´ÏùÑ Îã§Ïãú Î°úÎìúÌï©ÎãàÎã§...');
                    reloadAllSnippets(snippetId);
                },
                error: function (xhr, status, error) {
                    console.error(`ÌÉúÍ∑∏ Ï†úÍ±∞ Ïã§Ìå®:`, {
                        status: xhr.status,
                        error: error
                    });
                    showToast('ÌÉúÍ∑∏ Ï†úÍ±∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            });
        }

        // Ïä§ÎãàÌé´ ÌÉúÍ∑∏ UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateSnippetTagsUI(snippetId) {
            const card = $(`.snippet-card[data-snippet-id="${snippetId}"]`);
            const tagContainer = card.find('.tag-container');
            const tags = snippetTags[snippetId] || [];

            tagContainer.empty();

            if (tags.length === 0) {
                tagContainer.html('<span class="no-tags">ÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</span>');
            } else {
                tags.forEach(tag => {
                    const tagElement = $('<span class="tag-item">' + tag.name + '<span class="tag-remove">&times;</span></span>');
                    tagContainer.append(tagElement);
                });
            }
        }

        // Ïä§ÎãàÌé´ Îã§Ïãú Î°úÎìú Ìï®Ïàò
        function reloadAllSnippets(focusSnippetId) {
            console.log('===== Î™®Îì† Ïä§ÎãàÌé´ Îã§Ïãú Î°úÎìú ÏãúÏûë =====');
            console.log('Î°úÎìú ÌõÑ Ìè¨Ïª§Ïä§Ìï† Ïä§ÎãàÌé´ ID:', focusSnippetId);

            $('#snippetsContainer').html('<div class="loading">Ïä§ÎãàÌé´ÏùÑ Îã§Ïãú Î∂àÎü¨Ïò§Îäî Ï§ë...</div>');

            $.ajax({
                url: '/api/snippet',
                method: 'GET',
                success: function(snippets) {
                    console.log('Ïä§ÎãàÌé´ API Ìò∏Ï∂ú ÏÑ±Í≥µ, Ïä§ÎãàÌé´ Ïàò:', snippets.length);
                    allSnippets = snippets;
                    snippetTags = {};
                    loadSnippetTags(focusSnippetId);
                },
                error: function(xhr, status, error) {
                    console.error('Ïä§ÎãàÌé´ Îã§Ïãú Î°úÎìú Ïã§Ìå®:', error);
                    showToast('Ïä§ÎãàÌé´ÏùÑ Îã§Ïãú Î°úÎìúÌïòÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                    displaySnippets(allSnippets, focusSnippetId);
                }
            });
        }

        // Ïä§ÎãàÌé´ ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò
        function filterSnippets(keyword) {
            const filteredSnippets = allSnippets.filter(snippet => {
                const searchableText = [
                    snippet.title || '',
                    snippet.content || '',
                    snippet.memo || '',
                    snippet.language || '',
                    snippet.type || ''
                ].join(' ').toLowerCase();

                // ÌÉúÍ∑∏ÎèÑ Í≤ÄÏÉâÏóê Ìè¨Ìï®
                const tags = snippetTags[snippet.snippetId] || [];
                const tagNames = tags.map(tag => tag.name).join(' ').toLowerCase();

                return searchableText.includes(keyword) || tagNames.includes(keyword);
            });

            displaySnippets(filteredSnippets);
        }

        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showToast(message, type) {
            type = type || 'success';
            const toast = $('#toast');
            toast.removeClass('error').text(message);

            if (type === 'error') {
                toast.addClass('error');
            }

            toast.fadeIn(300);
            setTimeout(function () {
                toast.fadeOut(300);
            }, 3000);
        }

        // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showError(message) {
            $('#errorMessage').text(message).show();
        }

        // Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú ÏûêÎèôÏôÑÏÑ± Îã´Í∏∞
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.tag-input-container').length) {
                $('.autocomplete-list').hide();
            }
        });
    });

</script>
</body>
</html>