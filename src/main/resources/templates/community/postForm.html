<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 작성</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Summernote -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }

        .card {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .note-editor .dropdown-toggle::after {
            display: none;
        }

        .note-editor.note-frame {
            border-color: #dee2e6;
        }

        .note-editor .note-toolbar {
            background-color: #f8f9fa;
        }

        .form-label {
            font-weight: 500;
        }

        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: border-color 0.3s ease;
            background-color: #fafafa;
        }

        .file-upload-area:hover {
            border-color: #0d6efd;
        }

        .file-upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e3f2fd;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #f8f9fa;
            border-color: #0d6efd;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .file-item .file-info {
            flex-grow: 1;
        }

        .file-item .file-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .file-item .file-meta {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .file-item .remove-file {
            color: #dc3545;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-item .remove-file:hover {
            background-color: #f8d7da;
        }

        .attached-images {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }

        .attached-image {
            display: inline-block;
            margin: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .attached-image img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
        }

        .attached-image .image-info {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-edit me-2"></i>
            게시글 작성
        </h1>
        <a href="/community" class="btn btn-outline-secondary">
            <i class="fas fa-home me-1"></i>
            메인으로
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="postForm" th:action="@{/community/post/new}" method="post" enctype="multipart/form-data">

                <!-- 카테고리 선택 -->
                <div class="mb-3">
                    <label for="categoryId" class="form-label">
                        <i class="fas fa-folder me-1"></i>
                        게시판 선택 <span class="text-danger">*</span>
                    </label>
                    <select id="categoryId" name="categoryId" class="form-select" required>
                        <option value="">게시판을 선택하세요</option>
                        <option th:each="category : ${categories}"
                                th:value="${category.categoryId}"
                                th:text="${category.name}"></option>
                    </select>
                </div>

                <!-- 제목 -->
                <div class="mb-3">
                    <label for="title" class="form-label">
                        <i class="fas fa-heading me-1"></i>
                        제목 <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="title" name="title" class="form-control"
                           placeholder="제목을 입력하세요" required>
                </div>

                <!-- Summernote 에디터 -->
                <div class="mb-3">
                    <label for="summernote" class="form-label">
                        <i class="fas fa-align-left me-1"></i>
                        내용 <span class="text-danger">*</span>
                    </label>
                    <textarea id="summernote" name="content"></textarea>
                </div>

                <!-- 첨부된 이미지 미리보기 -->
                <div id="attachedImagesContainer" class="mb-3" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-images me-1"></i>
                        첨부된 이미지
                    </label>
                    <div id="attachedImages" class="attached-images"></div>
                </div>

                <!-- 파일 첨부 영역 -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-paperclip me-1"></i>
                        파일 첨부
                    </label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="fas fa-file-upload fa-2x mb-2 text-muted"></i>
                        <p class="mb-2">파일을 드래그하여 업로드하거나 클릭하여 선택하세요</p>
                        <input type="file" id="files" name="files" multiple class="form-control d-none"
                               accept=".pdf,.doc,.docx,.hwp,.txt,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.jpg,.jpeg,.png,.gif">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="$('#files').click()">
                            <i class="fas fa-plus me-1"></i>파일 선택
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                지원 형식: 문서(PDF, DOC, HWP 등), 이미지(JPG, PNG, GIF), 압축파일 등 (최대 10MB)
                            </small>
                        </div>
                    </div>
                    <div id="fileList" class="mt-3"></div>
                </div>

                <!-- 공지사항 설정 -->
                <div class="mb-3 form-check">
                    <input type="checkbox" id="isNotice" name="isNotice" class="form-check-input" value="true">
                    <label for="isNotice" class="form-check-label">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        공지사항으로 등록
                    </label>
                </div>

                <!-- 버튼 영역 -->
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="confirmCancel()">
                        <i class="fas fa-times me-1"></i>
                        취소
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>
                        등록
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let selectedFiles = [];
    let attachedImages = []; // Summernote에서 업로드된 이미지들

    $(document).ready(function() {
        // Summernote 초기화 (모든 기능 활성화)
        $('#summernote').summernote({
            height: 400,
            minHeight: null,
            maxHeight: null,
            focus: true,
            lang: 'ko-KR',
            placeholder: '내용을 입력하세요...',
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                onImageUpload: function(files) {
                    for (let i = 0; i < files.length; i++) {
                        uploadSummernoteImage(files[i], this);
                    }
                },
                onPaste: function(e) {
                    const clipboardData = e.originalEvent.clipboardData;
                    if (clipboardData && clipboardData.items) {
                        for (let i = 0; i < clipboardData.items.length; i++) {
                            const item = clipboardData.items[i];
                            if (item.type.indexOf('image') !== -1) {
                                const file = item.getAsFile();
                                uploadSummernoteImage(file, this);
                            }
                        }
                    }
                }
            }
        });

        setupFileDragDrop();
    });

    // Summernote 이미지 업로드
    function uploadSummernoteImage(file, editor) {
        // 파일 크기 체크 (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('이미지 크기가 너무 큽니다. 5MB 이하의 이미지만 업로드 가능합니다.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/community/upload-image',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                if (data.imageUrl) {
                    $(editor).summernote('insertImage', data.imageUrl);

                    // 첨부된 이미지 목록에 추가
                    attachedImages.push({
                        url: data.imageUrl,
                        name: file.name,
                        size: file.size
                    });

                    updateAttachedImagesDisplay();
                } else if (data.error) {
                    alert('이미지 업로드 실패: ' + data.error);
                }
            },
            error: function() {
                // 이미지 업로드 실패 시 파일 첨부 영역에 추가
                if (confirm('이미지 업로드에 실패했습니다. 파일로 첨부하시겠습니까?')) {
                    addFileToList(file);
                }
            }
        });
    }

    // 첨부된 이미지 표시 업데이트
    function updateAttachedImagesDisplay() {
        if (attachedImages.length === 0) {
            $('#attachedImagesContainer').hide();
            return;
        }

        $('#attachedImagesContainer').show();
        let html = '';

        attachedImages.forEach((image, index) => {
            html += `
                <div class="attached-image position-relative" style="position: relative;">
                    <img src="${image.url}" alt="${image.name}">
                    <button type="button" class="image-remove" onclick="removeAttachedImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="image-info">
                        ${image.name}
                        <br>
                        <small>${(image.size / 1024).toFixed(1)} KB</small>
                    </div>
                </div>
            `;
        });

        $('#attachedImages').html(html);
    }

    // 첨부된 이미지 제거
    function removeAttachedImage(index) {
        if (confirm('이미지를 제거하시겠습니까?')) {
            const removedImage = attachedImages[index];

            // Summernote 내용에서도 해당 이미지 제거
            let content = $('#summernote').summernote('code');
            content = content.replace(new RegExp(`<img[^>]*src="${removedImage.url}"[^>]*>`, 'g'), '');
            $('#summernote').summernote('code', content);

            // 배열에서 제거
            attachedImages.splice(index, 1);
            updateAttachedImagesDisplay();
        }
    }

    // 파일 드래그 앤 드롭 설정
    function setupFileDragDrop() {
        const uploadArea = $('#fileUploadArea');

        uploadArea.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        uploadArea.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        uploadArea.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            const files = e.originalEvent.dataTransfer.files;
            handleFileSelection(files);
        });

        uploadArea.on('click', function(e) {
            if (e.target === this || e.target.closest('button')) {
                $('#files').click();
            }
        });

        $('#files').change(function() {
            handleFileSelection(this.files);
        });
    }

    // 파일 선택 처리
    function handleFileSelection(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            if (file.size > 10 * 1024 * 1024) {
                alert(`${file.name} 파일이 너무 큽니다. 10MB 이하의 파일만 업로드 가능합니다.`);
                continue;
            }

            addFileToList(file);
        }
        updateFileInput();
    }

    // 파일 목록에 추가
    function addFileToList(file) {
        const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        selectedFiles.push({id: fileId, file: file});

        const fileSize = (file.size / 1024).toFixed(1);
        const fileIcon = getFileIcon(file.name);

        const fileHtml = `
            <div class="file-item" data-file-id="${fileId}">
                <div class="file-info">
                    <div class="file-name">
                        <i class="${fileIcon} me-2"></i>
                        <span onclick="downloadFile('${fileId}')" style="cursor: pointer; color: #0d6efd;">
                            ${file.name}
                        </span>
                    </div>
                    <div class="file-meta">크기: ${fileSize} KB | 타입: ${file.type || '알 수 없음'}</div>
                </div>
                <i class="fas fa-times remove-file" onclick="removeFile('${fileId}')" title="파일 제거"></i>
            </div>
        `;

        $('#fileList').append(fileHtml);
    }

    // 파일 다운로드 (미리보기)
    function downloadFile(fileId) {
        const fileObj = selectedFiles.find(f => f.id === fileId);
        if (fileObj && confirm(`${fileObj.file.name} 파일을 다운로드하시겠습니까?`)) {
            const url = URL.createObjectURL(fileObj.file);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileObj.file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }

    // 파일 제거
    function removeFile(fileId) {
        if (confirm('파일을 제거하시겠습니까?')) {
            selectedFiles = selectedFiles.filter(f => f.id !== fileId);
            $(`.file-item[data-file-id="${fileId}"]`).remove();
            updateFileInput();
        }
    }

    // 파일 입력 업데이트
    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(item => {
            dt.items.add(item.file);
        });
        $('#files')[0].files = dt.files;
    }

    // 파일 아이콘 반환
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'fas fa-file-pdf text-danger',
            'doc': 'fas fa-file-word text-primary',
            'docx': 'fas fa-file-word text-primary',
            'hwp': 'fas fa-file-alt text-info',
            'txt': 'fas fa-file-alt text-secondary',
            'xls': 'fas fa-file-excel text-success',
            'xlsx': 'fas fa-file-excel text-success',
            'ppt': 'fas fa-file-powerpoint text-warning',
            'pptx': 'fas fa-file-powerpoint text-warning',
            'zip': 'fas fa-file-archive text-dark',
            'rar': 'fas fa-file-archive text-dark',
            'jpg': 'fas fa-file-image text-info',
            'jpeg': 'fas fa-file-image text-info',
            'png': 'fas fa-file-image text-info',
            'gif': 'fas fa-file-image text-info'
        };
        return iconMap[ext] || 'fas fa-file text-muted';
    }

    // 폼 제출 처리
    $('#postForm').on('submit', function(e) {
        e.preventDefault();

        const title = $('#title').val().trim();
        const content = $('#summernote').summernote('code');
        const categoryId = $('#categoryId').val();

        if (!categoryId) {
            alert('게시판을 선택해주세요.');
            return;
        }

        if (!title) {
            alert('제목을 입력해주세요.');
            return;
        }

        if (content.trim() === '<p><br></p>' || !content.trim()) {
            alert('내용을 입력해주세요.');
            return;
        }

        if (confirm('게시글을 등록하시겠습니까?')) {
            this.submit();
        }
    });

    // 취소 확인
    function confirmCancel() {
        if (confirm('작성을 취소하시겠습니까? 작성 중인 내용이 모두 사라집니다.')) {
            window.location.href = '/community';
        }
    }
</script>
</body>
</html>