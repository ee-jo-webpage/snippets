<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íƒœê·¸ ê´€ë¦¬</title>
    <script th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        background: #f5f7fa;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
    }

    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 25px;
    }

    .card-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #34495e;
    }

    /* íƒœê·¸ ì…ë ¥ */
    .tag-input-wrapper {
        position: relative;
        max-width: 500px;
    }

    .tag-input-field {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
    }

    .tag-input-field:focus {
        border-color: #3498db;
    }

    /* ìë™ì™„ì„± */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-option {
        padding: 10px 15px;
        cursor: pointer;
    }

    .autocomplete-option:hover, .autocomplete-option.highlight {
        background: #f1f2f6;
    }

    /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        min-height: 50px;
        align-items: flex-start;
    }

    .tag-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        user-select: none;
    }

    .tag-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tag-badge.active {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    }

    .tag-delete {
        margin-left: 8px;
        font-weight: bold;
        opacity: 0.8;
    }

    .tag-delete:hover {
        opacity: 1;
    }

    /* ìŠ¤ë‹ˆí« í‘œì‹œ */
    .snippets-section {
        display: none;
    }

    .snippets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
    }

    .snippet-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        transition: transform 0.2s;
    }

    .snippet-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .snippet-header {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .snippet-meta {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .snippet-meta-item {
        background: #f8f9fa;
        color: #666;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    .snippet-language {
        background: #e8f5e9;
        color: #27ae60;
    }

    .snippet-type {
        background: #fff3e0;
        color: #f57c00;
    }

    .snippet-date {
        background: #f3e5f5;
        color: #8e24aa;
    }

    .snippet-body {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        border-left: 3px solid #3498db;
    }

    /* í…ìŠ¤íŠ¸ íƒ€ì… ìŠ¤ë‹ˆí« */
    .snippet-body.text-type {
        font-family: inherit;
        border-left-color: #27ae60;
    }

    .empty-message {
        text-align: center;
        color: #999;
        font-style: italic;
        padding: 20px;
    }

    .loading-text {
        text-align: center;
        color: #666;
        padding: 20px;
    }

    .help-message {
        background: #e3f2fd;
        color: #1565c0;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        .snippets-grid {
            grid-template-columns: 1fr;
        }

        .container {
            padding: 15px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ·ï¸ íƒœê·¸ ê´€ë¦¬</h1>

    <div class="card">
        <div class="card-title">íƒœê·¸ ì¶”ê°€</div>
        <div class="help-message">ğŸ’¡ íƒœê·¸ ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆŒëŸ¬ ìƒˆ íƒœê·¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ íƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <div class="tag-input-wrapper">
            <input type="text" id="tagInput" class="tag-input-field" placeholder="íƒœê·¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <div id="autocomplete" class="autocomplete-dropdown"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ì„ íƒëœ íƒœê·¸</div>
        <div id="selectedTags" class="tag-list">
            <div class="empty-message">ì„ íƒëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ì „ì²´ íƒœê·¸ ëª©ë¡</div>
        <div class="help-message">ğŸ’¡ íƒœê·¸ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ íƒœê·¸ë¥¼ ê°€ì§„ ìŠ¤ë‹ˆí« ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div id="allTags" class="tag-list">
            <div class="loading-text">íƒœê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <div id="snippetsSection" class="card snippets-section">
        <div class="card-title" id="snippetsTitle">ğŸ“ ìŠ¤ë‹ˆí« ëª©ë¡</div>
        <div id="snippetsGrid" class="snippets-grid"></div>
    </div>
</div>

<script th:inline="javascript">
    $(document).ready(function () {
        let selectedTags = [];
        let allTags = [];
        let currentIndex = -1;
        let autocompleteData = [];

        // ë”ë¯¸ ìŠ¤ë‹ˆí« ë°ì´í„° (ì½”ë“œì™€ í…ìŠ¤íŠ¸ë§Œ)
        const dummySnippets = [
            {
                id: 1,
                title: 'JavaScript ë°°ì—´ ë§µ',
                content: 'const numbers = [1, 2, 3, 4, 5];\nconst doubled = numbers.map(num => num * 2);',
                language: 'javascript',
                type: 'code',
                createdAt: '2023-02-01'
            },
            {
                id: 2,
                title: 'React Hook ì˜ˆì œ',
                content: 'const [count, setCount] = useState(0);',
                language: 'jsx',
                type: 'code',
                createdAt: '2023-02-03'
            },
            {
                id: 3,
                title: 'Java Stream API',
                content: 'list.stream().filter(x -> x > 0).collect(Collectors.toList());',
                language: 'java',
                type: 'code',
                createdAt: '2023-02-05'
            },
            {
                id: 4,
                title: 'Spring Boot Controller',
                content: '@RestController\npublic class ApiController { ... }',
                language: 'java',
                type: 'code',
                createdAt: '2023-02-07'
            },
            {
                id: 5,
                title: 'CSS Grid Layout',
                content: '.container { display: grid; grid-template-columns: repeat(3, 1fr); }',
                language: 'css',
                type: 'code',
                createdAt: '2023-02-09'
            },
            {
                id: 6,
                title: 'JavaScript í•™ìŠµ ë…¸íŠ¸',
                content: '# JavaScript ê¸°ì´ˆ\n\n1. ë³€ìˆ˜ ì„ ì–¸ (let, const, var)\n2. í•¨ìˆ˜ ì •ì˜ (function, arrow function)\n3. ì¡°ê±´ë¬¸ ì‚¬ìš©ë²• (if, switch)',
                type: 'text',
                createdAt: '2023-02-11'
            },
            {
                id: 7,
                title: 'Spring ì •ë¦¬',
                content: 'ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ í•µì‹¬ ê°œë…:\n\n- IoC (Inversion of Control)\n- DI (Dependency Injection)\n- AOP (Aspect Oriented Programming)',
                type: 'text',
                createdAt: '2023-02-13'
            }
        ];

        // íƒœê·¸ë³„ ìŠ¤ë‹ˆí« ë§¤í•‘
        const tagSnippetMap = {
            1: [1, 2, 6], // JavaScript
            2: [2],       // React
            3: [3, 4, 7], // Java
            4: [4, 7],    // Spring
            5: [1, 2, 5], // Frontend
            6: [3, 4, 7], // Backend
        };

        loadAllTags();

        // íƒœê·¸ ì…ë ¥ ìë™ì™„ì„±
        $('#tagInput').on('input', function () {
            const keyword = $(this).val().trim();
            currentIndex = -1;
            if (keyword.length > 0) {
                searchTags(keyword);
            } else {
                $('#autocomplete').hide();
            }
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        $('#tagInput').on('keydown', function (e) {
            const dropdown = $('#autocomplete');
            const options = dropdown.find('.autocomplete-option');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentIndex = Math.min(currentIndex + 1, options.length - 1);
                updateHighlight(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentIndex = Math.max(currentIndex - 1, 0);
                updateHighlight(options);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentIndex >= 0 && options.length > 0) {
                    const tag = autocompleteData[currentIndex];
                    addToSelected(tag);
                } else {
                    const tagName = $(this).val().trim();
                    if (tagName) createNewTag(tagName);
                }
                clearInput();
            } else if (e.key === 'Escape') {
                dropdown.hide();
            }
        });

        // ìë™ì™„ì„± í´ë¦­
        $(document).on('click', '.autocomplete-option', function () {
            const index = $(this).data('index');
            const tag = autocompleteData[index];
            addToSelected(tag);
            clearInput();
        });

        // íƒœê·¸ í´ë¦­ì‹œ ìŠ¤ë‹ˆí« ë¡œë“œ
        $(document).on('click', '.tag-badge:not(.selected-tag)', function () {
            const tagId = $(this).data('id');
            const tagName = $(this).text();
            if (tagId) {
                $('.tag-badge').removeClass('active');
                $(this).addClass('active');
                loadSnippets(tagId, tagName);
            }
        });

        // í•¨ìˆ˜ë“¤
        function searchTags(keyword) {
            $.ajax({
                url: /*[[@{/api/tag/search}]]*/ '/api/tag/search',
                method: 'GET',
                data: {query: keyword},
                success: function (tags) {
                    showAutocomplete(tags);
                },
                error: function () {
                    console.error('íƒœê·¸ ê²€ìƒ‰ ì˜¤ë¥˜');
                }
            });
        }

        function showAutocomplete(tags) {
            autocompleteData = tags;
            const dropdown = $('#autocomplete');
            if (tags.length > 0) {
                dropdown.empty();
                tags.forEach((tag, index) => {
                    dropdown.append($('<div>').addClass('autocomplete-option').text(tag.name).data('index', index));
                });
                dropdown.show();
            } else {
                dropdown.hide();
            }
        }

        function updateHighlight(options) {
            options.removeClass('highlight');
            if (currentIndex >= 0) {
                options.eq(currentIndex).addClass('highlight');
            }
        }

        function addToSelected(tag) {
            const exists = selectedTags.some(t => t.tagId === tag.tagId);
            if (!exists) {
                selectedTags.push(tag);
                displaySelected();
            }
        }

        function createNewTag(tagName) {
            $.ajax({
                url: /*[[@{/api/tag}]]*/ '/api/tag',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({name: tagName}),
                success: function (tag) {
                    addToSelected(tag);
                    loadAllTags();
                },
                error: function (xhr) {
                    if (xhr.status === 409) {
                        const existingTag = xhr.responseJSON;
                        if (existingTag) {
                            addToSelected(existingTag);
                        }
                    } else {
                        alert('íƒœê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            });
        }

        function clearInput() {
            $('#tagInput').val('');
            $('#autocomplete').hide();
            currentIndex = -1;
        }

        function displaySelected() {
            const container = $('#selectedTags');
            container.empty();
            if (selectedTags.length === 0) {
                container.html('<div class="empty-message">ì„ íƒëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>');
                return;
            }
            selectedTags.forEach((tag, index) => {
                const element = $('<span>').addClass('tag-badge selected-tag').data('id', tag.tagId);
                element.append($('<span>').text(tag.name));
                element.append($('<span>').addClass('tag-delete').html('&times;').on('click', function (e) {
                    e.stopPropagation();
                    selectedTags.splice(index, 1);
                    displaySelected();
                    // ì„ íƒëœ íƒœê·¸ê°€ ì—†ìœ¼ë©´ ìŠ¤ë‹ˆí« ëª©ë¡ ìˆ¨ê¸°ê¸°
                    if (selectedTags.length === 0) {
                        $('#snippetsSection').hide();
                    }
                }));
                container.append(element);
            });
        }

        function loadAllTags() {
            $.ajax({
                url: /*[[@{/api/tag}]]*/ '/api/tag',
                method: 'GET',
                success: function (tags) {
                    allTags = tags;
                    displayAllTags(tags);
                },
                error: function () {
                    console.error('íƒœê·¸ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜');
                    $('#allTags').html('<div class="empty-message">íƒœê·¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>');
                }
            });
        }

        function displayAllTags(tags) {
            const container = $('#allTags');
            container.empty();
            if (tags.length === 0) {
                container.html('<div class="empty-message">ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>');
                return;
            }
            tags.forEach(tag => {
                container.append($('<span>').addClass('tag-badge').text(tag.name).data('id', tag.tagId));
            });
        }

        function loadSnippets(tagId, tagName) {
            console.log('Loading snippets for tagId:', tagId, 'tagName:', tagName);

            $('#snippetsSection').show();
            $('#snippetsTitle').text('ğŸ“ "' + tagName + '" íƒœê·¸ì˜ ìŠ¤ë‹ˆí« ëª©ë¡');
            $('#snippetsGrid').html('<div class="loading-text">ìŠ¤ë‹ˆí«ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>');

            $.ajax({
                url: /*[[@{/api/tag/}]]*/ '/api/tag/' + tagId + '/snippets',
                method: 'GET',
                success: function (snippets) {
                    console.log('Received snippets:', snippets);
                    showSnippets(snippets, tagName);
                },
                error: function (xhr, status, error) {
                    console.error('API Error:', xhr.status, error);
                    console.log('Using dummy data for tagId:', tagId);

                    // ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
                    const snippetIds = tagSnippetMap[tagId] || [];
                    const snippets = dummySnippets.filter(s => snippetIds.includes(s.id));
                    showSnippets(snippets, tagName);
                }
            });
        }

        function showSnippets(snippets, tagName) {
            const container = $('#snippetsGrid');
            $('#snippetsTitle').text('ğŸ“ "' + tagName + '" íƒœê·¸ì˜ ìŠ¤ë‹ˆí« (' + snippets.length + 'ê°œ)');
            container.empty();

            if (snippets.length === 0) {
                container.html('<div class="empty-message">ì´ íƒœê·¸ì— í•´ë‹¹í•˜ëŠ” ìŠ¤ë‹ˆí«ì´ ì—†ìŠµë‹ˆë‹¤</div>');
                return;
            }

            snippets.forEach(snippet => {
                const card = $('<div>').addClass('snippet-card');

                // ì œëª©
                card.append($('<div>').addClass('snippet-header').text(snippet.title || snippet.memo || 'ì œëª© ì—†ìŒ'));

                // ë©”íƒ€ ì •ë³´
                const metaContainer = $('<div>').addClass('snippet-meta');

                if (snippet.language) {
                    metaContainer.append($('<span>').addClass('snippet-meta-item snippet-language').text(snippet.language));
                }

                if (snippet.type) {
                    metaContainer.append($('<span>').addClass('snippet-meta-item snippet-type').text(snippet.type));
                }

                if (snippet.createdAt) {
                    metaContainer.append($('<span>').addClass('snippet-meta-item snippet-date').text(snippet.createdAt));
                }

                if (metaContainer.children().length > 0) {
                    card.append(metaContainer);
                }

                // ë‚´ìš© (ì½”ë“œ ë˜ëŠ” í…ìŠ¤íŠ¸)
                const contentDiv = $('<div>')
                    .addClass('snippet-body')
                    .text(snippet.content || 'ë‚´ìš© ì—†ìŒ');

                // í…ìŠ¤íŠ¸ íƒ€ì…ì¸ ê²½ìš° ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
                if (snippet.type === 'text') {
                    contentDiv.addClass('text-type');
                }

                card.append(contentDiv);
                container.append(card);
            });
        }

        // ì™¸ë¶€ í´ë¦­ì‹œ ìë™ì™„ì„± ë‹«ê¸°
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.tag-input-wrapper').length) {
                $('#autocomplete').hide();
            }
        });
    });
</script>
</body>
</html>