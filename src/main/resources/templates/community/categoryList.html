<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Fonts - Pretendard 또는 Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6357FF;
            --secondary-color: #8075FF;
            --accent-color: #9F97FF;
            --background-gradient: linear-gradient(135deg, #F0F2FF 0%, #E6E9FF 100%);
            --text-dark: #333344;
            --text-muted: #666677;
            --border-color: #EAEAEA;
            --shadow-small: 0 2px 8px rgba(99, 87, 255, 0.08);
            --shadow-medium: 0 4px 12px rgba(99, 87, 255, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            background: var(--background-gradient);
            min-height: 100vh;
        }

        /* 헤더 스타일 */
        .community-header {
            background-color: #ffffff;
            color: var(--text-dark);
            padding: 1rem 0;
            box-shadow: var(--shadow-small);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .community-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            justify-content: flex-end;
        }

        .header-controls .btn {
            padding: 0.5rem 1rem;
            border-radius: 24px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn-outline {
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            background-color: transparent;
        }

        .header-btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-small);
        }

        /* 메인 컨테이너 */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
            max-width: 1200px;
            margin: 1.5rem auto;
            gap: 1.5rem;
            padding: 0 1rem;
        }

        /* 사이드바 스타일 */
        .sidebar {
            width: 250px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-small);
            overflow: hidden;
            flex-shrink: 0;
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .sidebar-header {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .category-menu {
            padding: 0.5rem 0;
            margin: 0;
            background: white;
        }

        .category-item {
            padding: 0.2rem 0.8rem;
        }

        .category-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            border-radius: 8px;
            cursor: pointer;
        }

        .category-link:hover {
            background: #f8f9fa;
            color: var(--primary-color);
        }

        .category-link.active {
            background: #f0f2ff;
            color: var(--primary-color);
            font-weight: 500;
        }

        .category-icon {
            margin-right: 0.75rem;
            width: 16px;
            text-align: center;
            color: var(--primary-color);
        }

        .category-count {
            margin-left: auto;
            background: #f0f2ff;
            color: var(--primary-color);
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
        }

        .category-link.active .category-count {
            background: var(--primary-color);
            color: white;
        }

        /* 메인 콘텐츠 영역 */
        .main-content {
            flex: 1;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-small);
        }

        /* 콘텐츠 헤더 */
        .content-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: white;
        }

        .content-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 0.5rem;
        }

        .content-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0;
        }

        .content-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .btn-primary-custom {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 24px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            color: white;
        }

        .btn-outline-custom {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1.5rem;
            border-radius: 24px;
            transition: all 0.3s ease;
        }

        .btn-outline-custom:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* 게시글 목록 스타일 */
        .post-list {
            padding: 0;
        }

        .post-item {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .post-item:hover {
            background: #f8f9fa;
        }

        .post-item.notice {
            background: #f0f2ff;
            border-left: 4px solid var(--primary-color);
        }

        .post-item.notice:hover {
            background: #e8ebff;
        }

        .post-number {
            width: 60px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .notice-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .post-content {
            flex: 1;
            margin: 0 1rem;
            min-width: 0;
        }

        .post-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            margin: 0 0 0.3rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-item:hover .post-title {
            color: var(--primary-color);
        }

        .post-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .post-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .post-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .post-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .comment-count {
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .new-badge {
            background: #ff4757;
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        /* 검색 필터 영역 */
        .search-filters {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: #fafafa;
        }

        .search-form {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .search-form .form-group {
            flex: 1;
        }

        .search-form .form-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .search-form .form-control,
        .search-form .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .search-form .form-control:focus,
        .search-form .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 87, 255, 0.25);
        }

        /* 로딩 상태 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        /* 페이지네이션 */
        .pagination-container {
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background: #fafafa;
        }

        .pagination {
            justify-content: center;
            margin: 0;
        }

        .pagination .page-link {
            color: var(--text-dark);
            border: 1px solid #ddd;
            margin: 0 0.2rem;
            border-radius: 6px;
        }

        .pagination .page-item.active .page-link {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .pagination .page-link:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* 모달 스타일 */
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-bottom: none;
        }

        .modal-header .btn-close {
            color: white;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .sidebar {
                width: 100%;
                position: static;
            }

            .category-menu {
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
            }

            .category-item {
                border-bottom: none;
                border-right: none;
                flex-shrink: 0;
            }

            .category-link {
                padding: 0.75rem 1rem;
                white-space: nowrap;
            }

            .post-item {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .post-number {
                width: auto;
                text-align: left;
            }

            .post-content {
                margin: 0;
                width: 100%;
            }

            .post-stats {
                align-self: flex-end;
            }

            .content-header {
                padding: 1rem;
            }

            .content-actions {
                flex-direction: column;
            }

            .search-form {
                flex-direction: column;
                gap: 1rem;
            }

            .search-filters {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<div class="community-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1>
                    <i class="fas fa-comments me-2"></i>
                    커뮤니티
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="header-controls">
                    <!-- 알림 버튼 -->
                    <button class="btn header-btn-outline position-relative" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                              id="notificationCount" style="display: none;">0</span>
                    </button>

                    <!-- 임시저장 버튼 -->
                    <button class="btn header-btn-outline" id="draftBtn">
                        <i class="fas fa-save me-1"></i>
                        임시저장
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div class="main-container">
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">게시판</h3>
        </div>
        <nav class="category-menu">
            <!-- 전체 게시글 -->
            <div class="category-item">
                <a class="category-link active" data-category="all" data-name="전체 게시글">
                    <i class="fas fa-home category-icon"></i>
                    전체 게시글
                    <span class="category-count" id="count-all">0</span>
                </a>
            </div>

            <!-- 카테고리 목록 (동적으로 로드) -->
            <div id="categoryList">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </nav>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content" style="position: relative;">
        <!-- 로딩 오버레이 -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>불러오는 중...</span>
            </div>
        </div>

        <!-- 콘텐츠 헤더 -->
        <div class="content-header">
            <h2 class="content-title" id="currentCategoryTitle">전체 게시글</h2>
            <p class="content-subtitle" id="currentCategoryDescription">
                모든 게시판의 글을 한 번에 볼 수 있습니다.
            </p>
            <div class="content-actions">
                <button class="btn btn-primary-custom" id="writePostBtn">
                    <i class="fas fa-edit me-1"></i>
                    글쓰기
                </button>
                <button class="btn btn-outline-custom" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search me-1"></i>
                    검색
                </button>
            </div>
        </div>

        <!-- 검색 필터 (검색 결과일 때만 표시) -->
        <div class="search-filters" id="searchFilters" style="display: none;">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label class="form-label">검색 유형</label>
                    <select name="searchType" class="form-select">
                        <option value="titleContent">제목+내용</option>
                        <option value="title">제목만</option>
                        <option value="content">내용만</option>
                        <option value="writer">작성자</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">검색어</label>
                    <input type="text" name="keyword" class="form-control" placeholder="검색어를 입력하세요">
                </div>
                <div class="form-group">
                    <label class="form-label">카테고리</label>
                    <select name="categoryId" class="form-select" id="searchCategorySelect">
                        <option value="">전체 카테고리</option>
                    </select>
                </div>
                <div>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-search me-1"></i>
                        검색
                    </button>
                </div>
            </form>
        </div>

        <!-- 게시글 목록 -->
        <div class="post-list" id="postList">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h4>게시글을 불러오는 중...</h4>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <nav aria-label="Page navigation">
                <ul class="pagination" id="pagination">
                    <!-- 동적으로 생성 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 검색 모달 -->
<div class="modal fade search-modal" id="searchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    게시글 검색
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form class="search-form" id="modalSearchForm">
                    <div class="mb-3">
                        <label class="form-label">검색 유형</label>
                        <select name="searchType" class="form-select">
                            <option value="titleContent">제목+내용</option>
                            <option value="title">제목만</option>
                            <option value="content">내용만</option>
                            <option value="writer">작성자</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">검색어</label>
                        <input type="text" name="keyword" class="form-control" placeholder="검색어를 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카테고리</label>
                        <select name="categoryId" class="form-select" id="modalSearchCategorySelect">
                            <option value="">전체 카테고리</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-search me-1"></i>
                            검색
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 알림 모달 -->
<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2"></i>
                    알림
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="notificationList">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i>
                        알림을 불러오는 중...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="markAllReadBtn">
                    <i class="fas fa-check-double me-1"></i>
                    모두 읽음 처리
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 임시저장 모달 -->
<div class="modal fade" id="draftModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-save me-2"></i>
                    임시저장 목록
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div id="draftList">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i>
                        임시저장 목록을 불러오는 중...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 전역 변수
    let currentCategoryId = 'all';
    let currentPage = 1;
    let isSearchMode = false;
    let searchParams = {};
    let categories = [];

    $(document).ready(function() {
        console.log('커뮤니티 페이지 초기화 시작');

        // 초기 데이터 로드
        initializePage();

        // 이벤트 바인딩
        bindEvents();

        // 알림 초기화
        loadNotificationCount();
    });

    // 페이지 초기화
    function initializePage() {
        // URL에서 초기 카테고리 확인
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('categoryId');

        console.log('URL에서 가져온 카테고리 파라미터:', categoryParam);

        if (categoryParam && categoryParam !== 'null') {
            currentCategoryId = parseInt(categoryParam); // 숫자로 변환
        } else {
            currentCategoryId = 'all'; // 기본값
        }

        console.log('초기 카테고리 ID:', currentCategoryId);

        loadCategories();
    }

    // 이벤트 바인딩
    function bindEvents() {
        // 카테고리 클릭 (이벤트 위임)
        $(document).on('click', '.category-link', function(e) {
            e.preventDefault();
            const categoryId = $(this).data('category');
            const categoryName = $(this).data('name');

            if (categoryId !== currentCategoryId) {
                switchCategory(categoryId, categoryName);
            }
        });

        // 글쓰기 버튼
        $('#writePostBtn').click(function() {
            const categoryParam = currentCategoryId !== 'all' ? `?categoryId=${currentCategoryId}` : '';
            window.location.href = `/community/post/new${categoryParam}`;
        });

        // 검색 폼 제출
        $('#searchForm, #modalSearchForm').on('submit', function(e) {
            e.preventDefault();
            performSearch(this);
        });

        // 알림 관련
        $('#notificationBtn').click(function() {
            loadNotifications();
            $('#notificationModal').modal('show');
        });

        $('#draftBtn').click(function() {
            loadDrafts();
            $('#draftModal').modal('show');
        });

        $('#markAllReadBtn').click(function() {
            markAllNotificationsAsRead();
        });

        // 게시글 클릭
        $(document).on('click', '.post-item', function() {
            const postId = $(this).data('post-id');
            if (postId) {
                window.location.href = `/community/post/${postId}`;
            }
        });

        // 페이지네이션
        $(document).on('click', '.pagination .page-link', function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (page && page !== currentPage) {
                if (isSearchMode) {
                    performSearch(null, page);
                } else {
                    loadPosts(currentCategoryId, page);
                }
            }
        });
    }

    // 카테고리 목록 로드
    function loadCategories() {
        $.ajax({
            url: '/api/community/categories',
            type: 'GET',
            success: function(response) {
                categories = response.categories || [];
                console.log('로드된 카테고리들:', categories);
                renderCategories();
                updateSearchCategoryOptions();

                // 카테고리 로드 후 게시글 로드
                loadPosts(currentCategoryId, 1);
            },
            error: function(xhr, status, error) {
                console.error('카테고리 로드 실패:', error);
                showToast('카테고리를 불러올 수 없습니다.', 'error');
            }
        });
    }

    // 카테고리 렌더링
    function renderCategories() {
        let html = '';

        categories.forEach(function(category) {
            const iconClass = getCategoryIcon(category.categoryId);
            html += `
            <div class="category-item">
                <a class="category-link"
                   data-category="${category.categoryId}"
                   data-name="${category.name}">
                    <i class="${iconClass} category-icon"></i>
                    ${category.name}
                    <span class="category-count" id="count-${category.categoryId}">0</span>
                </a>
            </div>
        `;
        });

        $('#categoryList').html(html);

        console.log('카테고리 렌더링 완료. 생성된 카테고리들:');
        categories.forEach(cat => console.log(`ID: ${cat.categoryId}, Name: ${cat.name}`));

        // 현재 활성 카테고리 설정
        updateActiveCategory();

        // 초기 헤더 정보 설정
        if (currentCategoryId === 'all') {
            updateContentHeader('all', '전체 게시글');
        } else {
            const category = categories.find(cat => cat.categoryId === parseInt(currentCategoryId));
            if (category) {
                updateContentHeader(currentCategoryId, category.name);
            }
        }
    }

    // 카테고리 전환
    function switchCategory(categoryId, categoryName) {
        if (categoryId === currentCategoryId) return;

        console.log('카테고리 전환 요청:', categoryId, categoryName);
        console.log('현재 카테고리 ID:', currentCategoryId);

        // 검색 모드 해제
        isSearchMode = false;
        $('#searchFilters').hide();

        // 현재 카테고리 ID 업데이트
        currentCategoryId = categoryId;

        // 헤더 정보 업데이트
        updateContentHeader(categoryId, categoryName);

        // 게시글 로드
        currentPage = 1;
        loadPosts(categoryId, 1);

        // URL 업데이트 (페이지 새로고침 없이)
        const newUrl = categoryId === 'all' ? '/community' : `/community?categoryId=${categoryId}`;
        history.pushState({categoryId: categoryId}, '', newUrl);
    }

    // 활성 카테고리 업데이트
    function updateActiveCategory() {
        $('.category-link').removeClass('active');
        $(`.category-link[data-category="${currentCategoryId}"]`).addClass('active');

        // 디버깅용 로그
        console.log('현재 활성 카테고리 ID:', currentCategoryId);
        console.log('선택된 요소:', $(`.category-link[data-category="${currentCategoryId}"]`).length);
    }

    // 콘텐츠 헤더 업데이트
    function updateContentHeader(categoryId, categoryName) {
        $('#currentCategoryTitle').text(categoryName);

        const descriptions = {
            'all': '모든 게시판의 글을 한 번에 볼 수 있습니다.',
            '1': '자유롭게 이야기를 나누는 공간입니다.',
            '2': '궁금한 것들을 질문하고 답변받는 공간입니다.',
            '3': '유용한 팁과 노하우를 공유하는 공간입니다.',
            '4': '중요한 공지사항을 확인할 수 있습니다.'
        };

        $('#currentCategoryDescription').text(descriptions[categoryId] || '게시글을 확인하세요.');

        // 활성 카테고리 표시 업데이트
        updateActiveCategory();
    }

    // 게시글 목록 로드
    function loadPosts(categoryId, page = 1) {
        showLoading();

        const url = categoryId === 'all'
            ? `/api/community/posts/all?page=${page}`
            : `/api/community/posts/category/${categoryId}?page=${page}`;

        $.ajax({
            url: url,
            type: 'GET',
            success: function(response) {
                hideLoading();
                renderPosts(response.posts || []);
                renderPagination(response.pagination);
                updateCategoryCounts(response.categoryCounts);
                currentPage = page;
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('게시글 로드 실패:', error);
                showErrorState('게시글을 불러올 수 없습니다.');
            }
        });
    }

    // 게시글 렌더링
    function renderPosts(posts) {
        if (posts.length === 0) {
            showEmptyState();
            return;
        }

        let html = '';
        posts.forEach(function(post) {
            html += renderSinglePost(post);
        });

        $('#postList').html(html);
    }

    // 단일 게시글 렌더링
    function renderSinglePost(post) {
        const isNotice = post.notice || false;
        const noticeClass = isNotice ? 'notice' : '';
        const commentCount = post.commentCount || 0;
        const isNew = isNewPost(post.createdAt);

        return `
        <div class="post-item ${noticeClass}" data-post-id="${post.postId}">
            <div class="post-number">
                ${isNotice ? '<span class="notice-badge"><i class="fas fa-bullhorn me-1"></i>공지</span>' : post.postId}
            </div>
            <div class="post-content">
                <div class="post-title">
                    ${post.title}
                    ${isNew ? '<span class="new-badge">NEW</span>' : ''}
                </div>
                <div class="post-meta">
                    <span><i class="fas fa-user"></i>${post.nickname}</span>
                    <span><i class="fas fa-calendar"></i>${formatDate(post.createdAt)}</span>
                    ${post.categoryName ? `<span class="badge bg-light text-dark">${post.categoryName}</span>` : ''}
                </div>
            </div>
            <div class="post-stats">
                <div class="post-stat">
                    <i class="fas fa-eye"></i>
                    <span>${post.viewCount || 0}</span>
                </div>
                ${commentCount > 0 ? `<div class="post-stat"><span class="comment-count">${commentCount}</span></div>` : ''}
            </div>
        </div>
    `;
    }

    // 검색 수행
    function performSearch(form, page = 1) {
        const formData = form ? new FormData(form) : null;

        if (formData) {
            searchParams = {
                searchType: formData.get('searchType') || 'titleContent',
                keyword: formData.get('keyword') || '',
                categoryId: formData.get('categoryId') || ''
            };
        }

        if (!searchParams.keyword) {
            showToast('검색어를 입력해주세요.', 'warning');
            return;
        }

        showLoading();

        $.ajax({
            url: '/api/community/search',
            type: 'GET',
            data: {
                ...searchParams,
                page: page
            },
            success: function(response) {
                hideLoading();
                isSearchMode = true;
                currentPage = page;

                // 검색 필터 표시
                $('#searchFilters').show();
                updateSearchFilters();

                // 헤더 업데이트
                $('#currentCategoryTitle').text(`검색 결과: "${searchParams.keyword}"`);
                $('#currentCategoryDescription').text(`총 ${response.totalCount || 0}개의 게시글을 찾았습니다.`);

                // 결과 렌더링
                renderPosts(response.posts || []);
                renderPagination(response.pagination);

                // 모달 닫기
                $('#searchModal').modal('hide');
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('검색 실패:', error);
                showErrorState('검색 중 오류가 발생했습니다.');
            }
        });
    }

    // 검색 필터 업데이트
    function updateSearchFilters() {
        const form = $('#searchForm')[0];
        if (form) {
            form.searchType.value = searchParams.searchType || 'titleContent';
            form.keyword.value = searchParams.keyword || '';
            form.categoryId.value = searchParams.categoryId || '';
        }
    }

    // 페이지네이션 렌더링
    function renderPagination(pagination) {
        if (!pagination || pagination.totalPages <= 1) {
            $('#paginationContainer').hide();
            return;
        }

        $('#paginationContainer').show();

        let html = '';
        const currentPage = pagination.currentPage;
        const totalPages = pagination.totalPages;

        // 이전 페이지
        html += `
        <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}" tabindex="-1">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;

        // 페이지 번호들
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `;
        }

        // 다음 페이지
        html += `
        <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;

        $('#pagination').html(html);
    }

    // 카테고리 개수 업데이트
    function updateCategoryCounts(counts) {
        if (!counts) return;

        Object.keys(counts).forEach(function(categoryId) {
            $(`#count-${categoryId}`).text(counts[categoryId]);
        });
    }

    // 검색 카테고리 옵션 업데이트
    function updateSearchCategoryOptions() {
        let options = '<option value="">전체 카테고리</option>';

        categories.forEach(function(category) {
            options += `<option value="${category.categoryId}">${category.name}</option>`;
        });

        $('#searchCategorySelect, #modalSearchCategorySelect').html(options);
    }

    // 로딩 표시/숨김
    function showLoading() {
        $('#loadingOverlay').show();
    }

    function hideLoading() {
        $('#loadingOverlay').hide();
    }

    // 빈 상태 표시
    function showEmptyState() {
        $('#postList').html(`
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4>게시글이 없습니다</h4>
            <p>첫 번째 게시글을 작성해보세요!</p>
            <button class="btn btn-primary-custom" onclick="$('#writePostBtn').click()">
                <i class="fas fa-edit me-1"></i>
                글쓰기
            </button>
        </div>
    `);
    }

    // 오류 상태 표시
    function showErrorState(message) {
        $('#postList').html(`
        <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>오류가 발생했습니다</h4>
            <p>${message}</p>
            <button class="btn btn-outline-custom" onclick="location.reload()">
                <i class="fas fa-refresh me-1"></i>
                새로고침
            </button>
        </div>
    `);
    }

    // 유틸리티 함수들
    function getCategoryIcon(categoryId) {
        const icons = {
            '1': 'fas fa-comments',
            '2': 'fas fa-question-circle',
            '3': 'fas fa-lightbulb',
            '4': 'fas fa-bullhorn'
        };
        return icons[categoryId] || 'fas fa-folder';
    }

    function isNewPost(createdAt) {
        const postDate = new Date(createdAt);
        const now = new Date();
        const diffHours = (now - postDate) / (1000 * 60 * 60);
        return diffHours <= 24;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = now - date;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        } else if (diffDays < 7) {
            return `${diffDays}일 전`;
        } else {
            return date.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' });
        }
    }

    function showToast(message, type = 'info') {
        const bgClass = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';

        const toast = $(`
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
            <div class="toast show" role="alert">
                <div class="toast-header ${bgClass} text-white">
                    <strong class="me-auto">알림</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        </div>
    `);

        $('body').append(toast);

        setTimeout(function() {
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }

    // 알림 관련 함수들
    function loadNotificationCount() {
        $.ajax({
            url: '/api/community/notification/unread-count',
            type: 'GET',
            success: function(response) {
                if (response.unreadCount > 0) {
                    $('#notificationCount').text(response.unreadCount).show();
                } else {
                    $('#notificationCount').hide();
                }
            },
            error: function() {
                console.log('알림 개수 로드 실패');
            }
        });
    }

    function loadNotifications() {
        $.ajax({
            url: '/api/community/notification/list',
            type: 'GET',
            success: function(response) {
                renderNotifications(response.notifications || []);
            },
            error: function() {
                $('#notificationList').html('<div class="text-center text-danger">알림을 불러올 수 없습니다.</div>');
            }
        });
    }

    function loadDrafts() {
        $.ajax({
            url: '/api/community/draft/list',
            type: 'GET',
            success: function(response) {
                renderDrafts(response.drafts || []);
            },
            error: function() {
                $('#draftList').html('<div class="text-center text-danger">임시저장 목록을 불러올 수 없습니다.</div>');
            }
        });
    }

    function renderNotifications(notifications) {
        let html = '';

        if (notifications.length === 0) {
            html = '<div class="text-center py-4 text-muted">새로운 알림이 없습니다.</div>';
        } else {
            notifications.forEach(function(notification) {
                const unreadClass = !notification.read ? 'bg-light' : '';
                const icon = getNotificationIcon(notification.type);
                const message = getNotificationMessage(notification);

                html += `
                <div class="notification-item ${unreadClass} p-3 border-bottom" data-id="${notification.notificationId}">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="${icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${notification.senderNickname || '시스템'}</div>
                            <div class="text-muted">${message}</div>
                            <small class="text-muted">${formatNotificationDate(notification.createdAt)}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary mark-read-btn" data-id="${notification.notificationId}">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            });
        }

        $('#notificationList').html(html);
    }

    function renderDrafts(drafts) {
        let html = '';

        if (drafts.length === 0) {
            html = '<div class="text-center py-4 text-muted">임시저장된 글이 없습니다.</div>';
        } else {
            drafts.forEach(function(draft) {
                html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title">${draft.title || '(제목 없음)'}</h6>
                                <p class="card-text text-muted">${truncateText(stripHtml(draft.content), 100)}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${formatNotificationDate(draft.updatedAt)}
                                </small>
                            </div>
                            <div class="ms-3">
                                <button class="btn btn-sm btn-primary me-2" onclick="editDraft(${draft.draftId})">
                                    <i class="fas fa-edit me-1"></i>
                                    수정
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDraft(${draft.draftId})">
                                    <i class="fas fa-trash me-1"></i>
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            });
        }

        $('#draftList').html(html);
    }

    function markAllNotificationsAsRead() {
        $.ajax({
            url: '/api/community/notification/read-all',
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    loadNotifications();
                    loadNotificationCount();
                }
            }
        });
    }

    // 개별 알림 읽음 처리
    $(document).on('click', '.mark-read-btn', function() {
        const notificationId = $(this).data('id');

        $.ajax({
            url: `/api/community/notification/read/${notificationId}`,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    loadNotifications();
                    loadNotificationCount();
                }
            }
        });
    });

    // 임시저장 관련
    function editDraft(draftId) {
        window.location.href = `/community/post/new?draftId=${draftId}`;
    }

    function deleteDraft(draftId) {
        if (confirm('정말 삭제하시겠습니까?')) {
            $.ajax({
                url: `/api/community/draft/${draftId}`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        loadDrafts();
                        showToast('임시저장이 삭제되었습니다.', 'success');
                    }
                }
            });
        }
    }

    function getNotificationIcon(type) {
        switch(type) {
            case 'new_comment': return 'fas fa-comment text-primary';
            case 'new_reply': return 'fas fa-reply text-info';
            case 'comment_like': return 'fas fa-heart text-danger';
            default: return 'fas fa-bell text-secondary';
        }
    }

    function getNotificationMessage(notification) {
        switch(notification.type) {
            case 'new_comment': return '회원님의 게시글에 새 댓글이 달렸습니다.';
            case 'new_reply': return '회원님의 댓글에 답글이 달렸습니다.';
            case 'comment_like': return '회원님의 댓글에 좋아요가 눌렸습니다.';
            default: return '새로운 알림이 있습니다.';
        }
    }

    function formatNotificationDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return '방금 전';
        if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
        if (diff < 86400000) return Math.floor(diff / 3600000) + '시간 전';

        return date.toLocaleDateString();
    }

    function truncateText(text, length) {
        if (!text) return '';
        return text.length > length ? text.substring(0, length) + '...' : text;
    }

    function stripHtml(html) {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
    }

    // 브라우저 뒤로가기/앞으로가기 지원
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.categoryId) {
            currentCategoryId = event.state.categoryId;
            loadPosts(currentCategoryId, 1);
            updateActiveCategory();

            // 카테고리명 찾기
            let categoryName = '전체 게시글';
            if (currentCategoryId !== 'all') {
                const category = categories.find(cat => cat.categoryId.toString() === currentCategoryId.toString());
                if (category) {
                    categoryName = category.name;
                }
            }
            updateContentHeader(currentCategoryId, categoryName);
        }
    });
</script>
</body>
</html>