<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë‹ˆí« ê´€ë¦¬ ì‚¬ì´íŠ¸</title>
    <link th:href="@{/color/css/user-colors.css}" rel="stylesheet">
    <link th:href="@{/my-snippet-page/css/my-snippet-page.css}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div th:replace="fragments/sidebar :: sidebar('colors')"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
<main class="main-content">
    <div class="container">
        <div class="color-container">
            <!-- ìƒ‰ìƒ ê´€ë¦¬ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="color-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h2 style="margin: 0; color: #333;">ìƒ‰ìƒ ê´€ë¦¬</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <a th:href="@{/color/user/{id}(id=${currentUserId})}"
                       style="text-decoration: none; color: #6c757d; padding: 8px 16px; border-radius: 4px; background: white; border: 1px solid #dee2e6;">
                        ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒ‰ìƒ
                    </a>
                    <button class="add-color-btn" onclick="openAddModal()"
                            style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        ğŸ¨ ìƒˆ ìƒ‰ìƒ ì¶”ê°€
                    </button>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ -->
            <div th:if="${currentUserId == null}" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. <a href="/login" class="alert-link">ë¡œê·¸ì¸í•˜ê¸°</a>
            </div>

            <!-- ìƒ‰ìƒ ëª©ë¡ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
            <div th:if="${currentUserId != null}">
                <div th:if="${not #lists.isEmpty(colorList)}" class="color-grid">
                    <div th:each="color, status : ${colorList}" class="color-card" th:style="'animation-delay: ' + ${status.index * 0.1} + 's;'">
                        <!-- ì†Œìœ ì í‘œì‹œ -->
                        <div th:if="${color.userId != null}" class="owner-badge"
                             th:text="${color.userId == currentUserId ? 'ë‚´ ìƒ‰ìƒ' : 'ì‚¬ìš©ì ' + color.userId}">
                            ìƒ‰ìƒ ì†Œìœ ì
                        </div>

                        <div class="color-preview" th:style="'background-color: ' + ${color.hexCode} + ';'">
                            <div class="color-hex-overlay" th:text="${color.hexCode}">#FFFFFF</div>
                        </div>
                        <div class="color-info">
                            <div class="color-name" th:text="${color.colorId}">ìƒ‰ìƒ ID</div>
                            <div class="color-name" th:text="${color.name}">ìƒ‰ìƒ ì´ë¦„</div>
                            <div class="color-hex" th:text="${color.hexCode}">#FFFFFF</div>

                            <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ë‚´ ìƒ‰ìƒì¼ ë•Œë§Œ í‘œì‹œ) -->
                            <div th:if="${color.userId == currentUserId or (isMyColors and color.userId != null)}" class="color-actions">
                                <button class="btn btn-edit"
                                        onclick="openEditModal(this)"
                                        th:data-color-id="${color.colorId}"
                                        th:data-name="${color.name}"
                                        th:data-hex-code="${color.hexCode}">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button class="btn btn-delete"
                                        onclick="deleteColor(this)"
                                        th:data-color-id="${color.colorId}"
                                        th:data-name="${color.name}">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(colorList)}" class="empty-state">
                    <div class="emoji">ğŸ¨</div>
                    <p>ë“±ë¡ëœ ìƒ‰ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <button th:if="${isMyColors}" class="add-color-btn" onclick="openAddModal()" style="margin-top: 20px;">
                        ğŸ¨ ì²« ë²ˆì§¸ ìƒ‰ìƒ ì¶”ê°€í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
            <div th:if="${currentUserId == null}" class="empty-state">
                <div class="emoji">ğŸ”’</div>
                <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                <p>ìƒ‰ìƒì„ ê´€ë¦¬í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                <a href="/login" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸í•˜ê¸°
                </a>
            </div>
        </div>
    </div>
    <!-- ìƒ‰ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ìƒˆ ìƒ‰ìƒ ì¶”ê°€</h2>
                <button class="close" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addColorForm" th:action="@{/color/add}" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addColorName" class="form-label">ìƒ‰ìƒ ì´ë¦„</label>
                        <input type="text" id="addColorName" name="name" class="form-control" required placeholder="ì˜ˆ: ìƒˆë²½ì˜ í‘¸ë¥¸ìƒ‰">
                    </div>
                    <div class="form-group">
                        <label for="addHexCode" class="form-label">ìƒ‰ìƒ ì½”ë“œ</label>
                        <div class="color-picker-container">
                            <input type="text" id="addHexCode" name="hexCode" class="form-control"
                                   pattern="^#[0-9A-Fa-f]{6}$" required placeholder="#FF0000">
                            <input type="color" id="addColorPicker" value="#FF0000" onchange="updateAddHexFromPicker()">
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ìƒ‰ìƒ ì„ íƒê¸°ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: #FF0000)
                        </small>
                    </div>
                    <div class="color-preview-box" id="addColorPreview" style="background-color: #FF0000;">
                        #FF0000
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal btn-secondary" onclick="closeAddModal()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn-modal btn-primary">
                        ì¶”ê°€
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìƒ‰ìƒ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ìƒ‰ìƒ ìˆ˜ì •</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <form id="editColorForm" th:action="@{/color/update}" method="POST">
                <input type="hidden" id="editColorId" name="colorId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editColorName" class="form-label">ìƒ‰ìƒ ì´ë¦„</label>
                        <input type="text" id="editColorName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editHexCode" class="form-label">ìƒ‰ìƒ ì½”ë“œ</label>
                        <div class="color-picker-container">
                            <input type="text" id="editHexCode" name="hexCode" class="form-control"
                                   pattern="^#[0-9A-Fa-f]{6}$" required placeholder="#FF0000">
                            <input type="color" id="editColorPicker" onchange="updateEditHexFromPicker()">
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ìƒ‰ìƒ ì„ íƒê¸°ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: #FF0000)
                        </small>
                    </div>
                    <div class="color-preview-box" id="editColorPreview" style="background-color: #FFFFFF;">
                        ë¯¸ë¦¬ë³´ê¸°
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal btn-secondary" onclick="closeModal()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn-modal btn-primary">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

</main>

<script th:inline="javascript">
    // ì„¸ì…˜ ì •ë³´ í† ê¸€ í•¨ìˆ˜
    function toggleSessionInfo() {
        const sessionInfo = document.getElementById('sessionInfo');
        if (sessionInfo.style.display === 'none' || sessionInfo.style.display === '') {
            sessionInfo.style.display = 'block';
            loadSessionData();
        } else {
            sessionInfo.style.display = 'none';
        }
    }

    // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadSessionData() {
        try {
            // ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸° (ì¿ í‚¤ì—ì„œ)
            const cookies = document.cookie.split(';');
            let sessionId = 'ì¿ í‚¤ì—ì„œ ì„¸ì…˜IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ';

            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'JSESSIONID' || name === 'connect.sid') {
                    sessionId = value;
                    break;
                }
            }
            document.getElementById('sessionId').textContent = sessionId;

            // ì„œë²„ ì„¸ì…˜ ë°ì´í„° í™•ì¸ API í˜¸ì¶œ
            try {
                const response = await fetch('/color/check-session');
                if (response.ok) {
                    const sessionData = await response.json();
                    document.getElementById('serverSessionData').innerHTML =
                        `userId: ${sessionData.userId || 'ì—†ìŒ'}, ` +
                        `sessionId: ${sessionData.sessionId || 'ì—†ìŒ'}`;
                } else {
                    document.getElementById('serverSessionData').textContent =
                        'API ì‘ë‹µ ì˜¤ë¥˜ - ì„œë²„ì—ì„œ í™•ì¸í•˜ì„¸ìš”';
                }
            } catch (error) {
                document.getElementById('serverSessionData').textContent =
                    `ì„¸ì…˜ í™•ì¸ API ì—†ìŒ - ${error.message}`;
                console.log('ì„¸ì…˜ í™•ì¸ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
            }
        } catch (error) {
            console.error('ì„¸ì…˜ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            document.getElementById('serverSessionData').textContent = 'ì˜¤ë¥˜ ë°œìƒ';
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì„¸ì…˜ ì •ë³´ í‘œì‹œ (ê°œë°œ ë‹¨ê³„ì—ì„œë§Œ)
    document.addEventListener('DOMContentLoaded', function() {
        // ê°œë°œ ëª¨ë“œì—ì„œ ìë™ìœ¼ë¡œ ì„¸ì…˜ ì •ë³´ í‘œì‹œ
        // toggleSessionInfo();
    });

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    /*[# th:if="${message != null}"]*/
    showAlert(/*[[${message}]]*/ 'ë©”ì‹œì§€', 'success');
    /*[/]*/

    /*[# th:if="${error != null}"]*/
    showAlert(/*[[${error}]]*/ 'ì˜¤ë¥˜', 'error');
    /*[/]*/

    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        document.body.appendChild(alert);

        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¡œ í‘œì‹œ
        setTimeout(() => alert.classList.add('show'), 100);

        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }

    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ëª¨ë‹¬ ì ‘ê·¼ ì°¨ë‹¨
    function openAddModal() {
        const currentUserId = /*[[${currentUserId}]]*/ null;
        if (!currentUserId) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            return;
        }

        // í¼ ì´ˆê¸°í™”
        document.getElementById('addColorForm').reset();
        document.getElementById('addHexCode').value = '#FF0000';
        document.getElementById('addColorPicker').value = '#FF0000';
        updateAddPreview();

        const modal = document.getElementById('addModal');
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeAddModal() {
        const modal = document.getElementById('addModal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // ìƒ‰ìƒ ì„ íƒê¸°ì—ì„œ hex ì½”ë“œ ì—…ë°ì´íŠ¸ (ì¶”ê°€ ëª¨ë‹¬)
    function updateAddHexFromPicker() {
        const picker = document.getElementById('addColorPicker');
        const hexInput = document.getElementById('addHexCode');
        const preview = document.getElementById('addColorPreview');

        hexInput.value = picker.value;
        preview.style.backgroundColor = picker.value;
        preview.textContent = picker.value;
    }

    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì¶”ê°€ ëª¨ë‹¬)
    function updateAddPreview() {
        const hexCode = document.getElementById('addHexCode').value;
        const preview = document.getElementById('addColorPreview');

        if (/^#[0-9A-Fa-f]{6}$/i.test(hexCode)) {
            preview.style.backgroundColor = hexCode;
            preview.textContent = hexCode;
            document.getElementById('addColorPicker').value = hexCode;
        }
    }

    // hex ì½”ë“œ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì¶”ê°€ ëª¨ë‹¬)
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('addHexCode').addEventListener('input', updateAddPreview);
    });

    // ìƒ‰ìƒ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ì½”ë“œ)
    function openEditModal(buttonElement) {
        const currentUserId = /*[[${currentUserId}]]*/ null;
        if (!currentUserId) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            return;
        }

        const colorId = buttonElement.getAttribute('data-color-id');
        const name = buttonElement.getAttribute('data-name');
        const hexCode = buttonElement.getAttribute('data-hex-code');

        document.getElementById('editColorId').value = colorId;
        document.getElementById('editColorName').value = name;
        document.getElementById('editHexCode').value = hexCode;
        document.getElementById('editColorPicker').value = hexCode;
        updateEditPreview();

        const modal = document.getElementById('editModal');
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // ìƒ‰ìƒ ì„ íƒê¸° ì—…ë°ì´íŠ¸ (ìˆ˜ì • ëª¨ë‹¬)
    function updateEditHexFromPicker() {
        const picker = document.getElementById('editColorPicker');
        const hexInput = document.getElementById('editHexCode');
        const preview = document.getElementById('editColorPreview');

        hexInput.value = picker.value;
        preview.style.backgroundColor = picker.value;
        preview.textContent = picker.value;
    }

    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ìˆ˜ì • ëª¨ë‹¬)
    function updateEditPreview() {
        const hexCode = document.getElementById('editHexCode').value;
        const preview = document.getElementById('editColorPreview');

        if (/^#[0-9A-Fa-f]{6}$/i.test(hexCode)) {
            preview.style.backgroundColor = hexCode;
            preview.textContent = hexCode;
            document.getElementById('editColorPicker').value = hexCode;
        }
    }

    // hex ì½”ë“œ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ìˆ˜ì • ëª¨ë‹¬)
    document.addEventListener('DOMContentLoaded', function() {
        const editHexInput = document.getElementById('editHexCode');
        if (editHexInput) {
            editHexInput.addEventListener('input', updateEditPreview);
        }
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const addModal = document.getElementById('addModal');
        const editModal = document.getElementById('editModal');

        if (event.target === addModal) {
            closeAddModal();
        }
        if (event.target === editModal) {
            closeModal();
        }
    }

    // ìƒ‰ìƒ ì‚­ì œ
    function deleteColor(buttonElement) {
        const currentUserId = /*[[${currentUserId}]]*/ null;
        if (!currentUserId) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            return;
        }

        const colorId = buttonElement.getAttribute('data-color-id');
        const name = buttonElement.getAttribute('data-name');

        if (confirm(`ì •ë§ë¡œ "${name}" ìƒ‰ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // ë™ì ìœ¼ë¡œ í¼ ìƒì„±í•˜ì—¬ ì œì¶œ
            const form = document.createElement('form');
            form.method = 'POST';  // DELETE ë©”ì„œë“œëŠ” í¼ì—ì„œ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠìŒ
            form.action = /*[[@{/color/delete}]]*/ '/color/delete';

            // Springì—ì„œ DELETE ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ íˆë“  í•„ë“œ
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'DELETE';
            form.appendChild(methodInput);

            // colorId íŒŒë¼ë¯¸í„°
            const colorIdInput = document.createElement('input');
            colorIdInput.type = 'hidden';
            colorIdInput.name = 'colorId';
            colorIdInput.value = colorId;
            form.appendChild(colorIdInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
            closeAddModal();
        }
    });
</script>
</body>
</html>