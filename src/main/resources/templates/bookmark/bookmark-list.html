<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ë¶ë§ˆí¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/bookmark/css/bookmark-list.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <!-- í—¤ë” (user-colorsì™€ ë™ì¼í•œ êµ¬ì¡°) -->
    <div class="header">
        <h1>ğŸ“š ë‚´ ë¶ë§ˆí¬</h1>
        <div class="navigation">
            <a th:href="@{/snippets}">ìŠ¤ë‹ˆí« ë‘˜ëŸ¬ë³´ê¸°</a>
            <div class="bookmark-count" th:text="|ì´ ${count}ê°œì˜ ë¶ë§ˆí¬|">ì´ 0ê°œì˜ ë¶ë§ˆí¬</div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <!-- ê²€ìƒ‰ ì„¹ì…˜ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
    <div th:if="${userId != null}" class="search-section">
        <div class="search-bar">
            <input type="text"
                   id="bookmarkSearchInput"
                   class="search-input"
                   placeholder="ë¶ë§ˆí¬ ê²€ìƒ‰ (ì œëª©, ë©”ëª¨, ìŠ¤ë‹ˆí« ID...)">
            <select id="bookmarkTypeFilter" class="filter-select">
                <option value="">ëª¨ë“  íƒ€ì…</option>
                <option value="CODE">ì½”ë“œ</option>
                <option value="TEXT">í…ìŠ¤íŠ¸</option>
                <option value="IMG">ì´ë¯¸ì§€</option>
            </select>
        </div>
    </div>

    <!-- ë¶ë§ˆí¬ ëª©ë¡ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
    <div th:if="${userId != null}">
        <div th:if="${not #lists.isEmpty(bookmarks)}" class="bookmarks-grid" id="bookmarksContainer">
            <div th:each="bookmark, stat : ${bookmarks}"
                 class="bookmark-card"
                 th:data-type="${bookmark.type?.name()}"
                 th:data-memo="${bookmark.memo}"
                 th:style="'animation-delay: ' + ${stat.index * 0.1} + 's;'">

                <div class="snippet-id" th:text="'#' + ${bookmark.snippetId}">ID</div>

                <div class="bookmark-header">
                    <h3 class="bookmark-title" th:text="${bookmark.memo ?: 'ì œëª© ì—†ìŒ'}">
                        ë¶ë§ˆí¬ ì œëª©
                    </h3>
                    <div class="bookmark-actions">
                        <a th:href="@{/snippets/{id}(id=${bookmark.snippetId})}" class="btn btn-view">
                            ğŸ‘ï¸ ë³´ê¸°
                        </a>
                        <button class="btn btn-delete"
                                th:onclick="|removeBookmark(${bookmark.snippetId})|">
                            ğŸ—‘ï¸ ì œê±°
                        </button>
                    </div>
                </div>

                <div class="snippet-meta">
                    <span class="meta-item"
                          th:classappend="${bookmark.type?.name() == 'CODE' ? 'type-code' : (bookmark.type?.name() == 'TEXT' ? 'type-text' : 'type-img')}"
                          th:text="${bookmark.type?.name() ?: 'íƒ€ì… ì—†ìŒ'}">íƒ€ì…</span>
                    <span class="meta-item" th:text="'ìƒì„±ì¼: ' + ${#dates.format(bookmark.createdAt, 'yyyy-MM-dd')}">ìƒì„±ì¼</span>
                    <span class="meta-item" th:if="${bookmark.sourceUrl}" th:text="'ì¶œì²˜ ìˆìŒ'">ì¶œì²˜</span>
                </div>

                <!-- íƒ€ì…ë³„ ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸° -->
                <div class="snippet-content" th:if="${bookmark.memo}">
                    <div th:text="${#strings.abbreviate(bookmark.memo, 200)}">
                        ìŠ¤ë‹ˆí« ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                    </div>
                </div>

                <!-- ì½”ë“œ íƒ€ì… ë¯¸ë¦¬ë³´ê¸° -->
                <div th:if="${bookmark.type?.name() == 'CODE'}" class="snippet-content">
                    <strong>ì½”ë“œ:</strong>
                    <pre th:text="${#strings.abbreviate(bookmark.Content, 150)}">ì½”ë“œ ë‚´ìš©</pre>
                    <span th:if="${bookmark.language}" class="meta-item" th:text="'ì–¸ì–´: ' + ${bookmark.language}">ì–¸ì–´</span>
                </div>

                <!-- í…ìŠ¤íŠ¸ íƒ€ì… ë¯¸ë¦¬ë³´ê¸° -->
                <div th:if="${bookmark.type?.name() == 'TEXT'}" class="snippet-content">
                    <strong>í…ìŠ¤íŠ¸:</strong>
                    <p th:text="${#strings.abbreviate(bookmark.Content, 200)}">í…ìŠ¤íŠ¸ ë‚´ìš©</p>
                </div>

                <!-- ì´ë¯¸ì§€ íƒ€ì… ë¯¸ë¦¬ë³´ê¸° -->
                <div th:if="${bookmark.type?.name() == 'IMG'}" class="snippet-content">
                    <strong>ì´ë¯¸ì§€:</strong>
                    <img th:if="${bookmark.imageUrl}"
                         th:src="${bookmark.imageUrl}"
                         th:alt="${bookmark.altText}"
                         style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                    <p th:if="${bookmark.altText}" th:text="${bookmark.altText}">ì´ë¯¸ì§€ ì„¤ëª…</p>
                </div>
            </div>
        </div>

        <!-- ë¶ë§ˆí¬ê°€ ì—†ëŠ” ê²½ìš° -->
        <div th:if="${#lists.isEmpty(bookmarks)}" class="empty-state">
            <div class="emoji">ğŸŒŸ</div>
            <p>ì•„ì§ ë¶ë§ˆí¬í•œ ìŠ¤ë‹ˆí«ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p>ë§ˆìŒì— ë“œëŠ” ìŠ¤ë‹ˆí«ì„ ë¶ë§ˆí¬í•˜ì—¬ ë‚˜ì¤‘ì— ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”!</p>
            <a th:href="@{/snippets}" class="btn btn-primary">
                <i class="fas fa-search"></i> ìŠ¤ë‹ˆí« ë‘˜ëŸ¬ë³´ê¸°
            </a>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
    <div th:if="${userId == null}" class="empty-state">
        <div class="emoji">ğŸ”’</div>
        <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p>ë¶ë§ˆí¬ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        <a href="/login" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸í•˜ê¸°
        </a>
    </div>
</div>

<script th:inline="javascript">
    // ì„¸ì…˜ ì •ë³´ í† ê¸€ í•¨ìˆ˜ (user-colorsì™€ ë™ì¼)
    function toggleSessionInfo() {
        const sessionInfo = document.getElementById('sessionInfo');
        if (sessionInfo.style.display === 'none' || sessionInfo.style.display === '') {
            sessionInfo.style.display = 'block';
            loadSessionData();
        } else {
            sessionInfo.style.display = 'none';
        }
    }

    // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadSessionData() {
        try {
            const cookies = document.cookie.split(';');
            let sessionId = 'ì¿ í‚¤ì—ì„œ ì„¸ì…˜IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ';

            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'JSESSIONID' || name === 'connect.sid') {
                    sessionId = value;
                    break;
                }
            }
            document.getElementById('sessionId').textContent = sessionId;
        } catch (error) {
            console.error('ì„¸ì…˜ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
        }
    }

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ (user-colorsì™€ ë™ì¼)
    /*[# th:if="${message != null}"]*/
    showAlert(/*[[${message}]]*/ 'ë©”ì‹œì§€', 'success');
    /*[/]*/

    /*[# th:if="${error != null}"]*/
    showAlert(/*[[${error}]]*/ 'ì˜¤ë¥˜', 'error');
    /*[/]*/

    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        document.body.appendChild(alert);

        setTimeout(() => alert.classList.add('show'), 100);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }

    // ë¶ë§ˆí¬ ì œê±° í•¨ìˆ˜
    function removeBookmark(snippetId) {
        if (!confirm('ì •ë§ë¡œ ì´ ë¶ë§ˆí¬ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/bookmark/remove/' + snippetId;

        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

        if (csrfToken && csrfHeader) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }

    // ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('bookmarkSearchInput');
        const typeFilter = document.getElementById('bookmarkTypeFilter');
        const bookmarksContainer = document.getElementById('bookmarksContainer');

        if (searchInput && typeFilter && bookmarksContainer) {
            function filterBookmarks() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const bookmarkCards = bookmarksContainer.querySelectorAll('.bookmark-card');

                bookmarkCards.forEach(card => {
                    const memo = card.getAttribute('data-memo') || '';
                    const type = card.getAttribute('data-type') || '';
                    const snippetId = card.querySelector('.snippet-id').textContent;

                    const matchesSearch = memo.toLowerCase().includes(searchTerm) ||
                        snippetId.toLowerCase().includes(searchTerm);
                    const matchesType = !selectedType || type === selectedType;

                    if (matchesSearch && matchesType) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterBookmarks);
            typeFilter.addEventListener('change', filterBookmarks);
        }
    });
</script>
</body>
</html>