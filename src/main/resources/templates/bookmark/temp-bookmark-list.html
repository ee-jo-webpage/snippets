<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ë¶ë§ˆí¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/bookmark/css/bookmark-list.css}" rel="stylesheet">
    <link th:href="@{/my-snippet-page/css/my-snippet-page.css}" rel="stylesheet">
</head>
<body>

<!-- í—¤ë” í¬í•¨ -->
<div th:replace="fragments/header :: header"></div>

<!-- ì‚¬ì´ë“œë°” í¬í•¨ -->
<div th:replace="fragments/sidebar :: sidebar('bookmarks')"></div>

<!-- ë©”ì¸ ì»¨í…ì¸ ë¥¼ ì‚¬ì´ë“œë°”ê°€ ìˆëŠ” ë ˆì´ì•„ì›ƒì— ë§ê²Œ ì¡°ì • -->
<main class="main-content">
    <div class="container">
        <!-- ë¶ë§ˆí¬ ê´€ë¦¬ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bookmark-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h2 style="margin: 0; color: #333;">ğŸ“š ë‚´ ë¶ë§ˆí¬</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a th:href="@{/snippets}"
                   style="text-decoration: none; color: #6c757d; padding: 8px 16px; border-radius: 4px; background: white; border: 1px solid #dee2e6;">
                    ğŸ“‹ ìŠ¤ë‹ˆí« ë‘˜ëŸ¬ë³´ê¸°
                </a>
                <div class="bookmark-count" th:text="|ì´ ${count}ê°œì˜ ë¶ë§ˆí¬|" style="color: #6c757d; font-size: 14px;">ì´ 0ê°œì˜ ë¶ë§ˆí¬</div>
            </div>
        </div>

        <!-- ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
        <div th:if="${userId != null}" class="search-section">
            <div class="search-bar">
                <input type="text"
                       id="bookmarkSearchInput"
                       class="search-input"
                       placeholder="ë¶ë§ˆí¬ ê²€ìƒ‰ (ì œëª©, ë©”ëª¨, ìŠ¤ë‹ˆí« ID...)">
                <select id="bookmarkTypeFilter" class="filter-select">
                    <option value="">ëª¨ë“  íƒ€ì…</option>
                    <option value="CODE">ì½”ë“œ</option>
                    <option value="TEXT">í…ìŠ¤íŠ¸</option>
                    <option value="IMG">ì´ë¯¸ì§€</option>
                </select>
            </div>
        </div>

        <!-- ë¶ë§ˆí¬ ëª©ë¡ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
        <div th:if="${userId != null}">
            <div th:if="${not #lists.isEmpty(bookmarks)}" class="bookmarks-grid" id="bookmarksContainer">
                <div th:each="bookmark, stat : ${bookmarks}"
                     class="bookmark-card"
                     th:data-type="${bookmark.type?.name()}"
                     th:data-memo="${bookmark.memo != null ? bookmark.memo : ''}"
                     th:data-content="${bookmark.content != null ? bookmark.content : ''}"
                     th:data-snippet-id="${bookmark.snippetId}"
                     th:style="'animation-delay: ' + ${stat.index * 0.1} + 's;' + (${bookmark.hexCode != null} ? ' border-left: 5px solid ' + ${bookmark.hexCode} + ';' : '')"
                     th:classappend="${bookmark.hexCode != null ? 'has-color' : ''}">

                    <!-- ìƒ‰ìƒ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
<!--                    <div th:if="${bookmark.hexCode != null and bookmark.name != null}"-->
<!--                         class="color-indicator"-->
<!--                         th:style="'background-color: ' + ${bookmark.hexCode}">-->
<!--                        <span class="color-name" th:text="${bookmark.name}">ìƒ‰ìƒëª…</span>-->
<!--                    </div>-->

                    <div class="snippet-id" th:text="'#' + ${bookmark.snippetId}">ID</div>

                    <div class="bookmark-header">
                        <div class="bookmark-actions">
                            <a th:href="@{/snippets/{id}(id=${bookmark.snippetId})}" class="btn btn-view">
                                ğŸ‘ï¸ ë³´ê¸°
                            </a>
                            <button class="btn btn-delete"
                                    th:onclick="|removeBookmark(${bookmark.snippetId})|">
                                ğŸ—‘ï¸ ì œê±°
                            </button>
                        </div>
                    </div>

                    <div class="snippet-meta">
                        <span class="meta-item"
                              th:classappend="${bookmark.type?.name() == 'CODE' ? 'type-code' : (bookmark.type?.name() == 'TEXT' ? 'type-text' : 'type-img')}"
                              th:text="${bookmark.type?.name() != null ? bookmark.type.name() : 'Unknown'}">íƒ€ì…</span>
                        <span class="meta-item" th:text="'ìƒì„±ì¼: ' + ${#dates.format(bookmark.createdAt, 'yyyy-MM-dd')}">ìƒì„±ì¼</span>
                        <span class="meta-item" th:if="${bookmark.language}" th:text="'ì–¸ì–´: ' + ${bookmark.language}">ì–¸ì–´</span>
                        <span class="meta-item" th:if="${bookmark.sourceUrl}" th:text="'ì¶œì²˜ ìˆìŒ'">ì¶œì²˜</span>
                    </div>

                    <!-- ìŠ¤ë‹ˆí« ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸° (ë©”ì¸ ì½˜í…ì¸ ) - í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì • -->
                    <a th:href="@{/snippets/{id}(id=${bookmark.snippetId})}" class="snippet-content-link">
                        <div class="snippet-content">
                            <!-- ì½”ë“œ íƒ€ì… -->
                            <div th:if="${bookmark.type?.name() == 'CODE'}" class="code-preview">
                                <div th:if="${bookmark.language}" class="language-badge" th:text="${bookmark.language}">ì–¸ì–´</div>
                                <pre th:text="${#strings.abbreviate(bookmark.content != null ? bookmark.content : 'No Code', 300)}">ì½”ë“œ ë‚´ìš©</pre>
                            </div>

                            <!-- í…ìŠ¤íŠ¸ íƒ€ì… -->
                            <div th:if="${bookmark.type?.name() == 'TEXT'}" class="text-preview">
                                <p th:text="${#strings.abbreviate(bookmark.content != null ? bookmark.content : 'No Text', 250)}">í…ìŠ¤íŠ¸ ë‚´ìš©</p>
                            </div>

                            <!-- ì´ë¯¸ì§€ íƒ€ì… -->
                            <div th:if="${bookmark.type?.name() == 'IMG'}" class="image-preview">
                                <div th:if="${bookmark.imageUrl}" class="image-container">
                                    <img th:src="${bookmark.imageUrl}"
                                         th:alt="${bookmark.altText != null ? bookmark.altText : 'Image'}"
                                         class="preview-image"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="image-error" style="display: none;">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                                </div>
                                <p th:if="${bookmark.altText}" class="image-alt" th:text="${bookmark.altText}">ì´ë¯¸ì§€ ì„¤ëª…</p>
                                <div th:if="${bookmark.content and bookmark.content != bookmark.altText}"
                                     class="image-content"
                                     th:text="${#strings.abbreviate(bookmark.content, 150)}">ì¶”ê°€ ë‚´ìš©</div>
                            </div>

                            <!-- íƒ€ì…ì´ ì—†ê±°ë‚˜ ì¼ë°˜ì ì¸ ê²½ìš° -->
                            <div th:if="${bookmark.type == null}" class="general-preview">
                                <p th:text="${#strings.abbreviate(bookmark.content != null ? bookmark.content : 'No Content', 250)}">ì¼ë°˜ ë‚´ìš©</p>
                            </div>
                        </div>
                    </a>

                    <!-- ë©”ëª¨ê°€ ìˆê³  ì½˜í…ì¸ ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ í‘œì‹œ -->
                    <div th:if="${#strings.length(bookmark.memo != null ? bookmark.memo : '') > 0 and bookmark.memo != bookmark.content}" class="snippet-memo">
                        <strong>ğŸ“ ë©”ëª¨:</strong>
                        <span th:text="${#strings.abbreviate(bookmark.memo, 100)}">ë©”ëª¨ ë‚´ìš©</span>
                    </div>

                    <!-- URLì´ ìˆëŠ” ê²½ìš° ì¶œì²˜ ë§í¬ í‘œì‹œ -->
                    <div th:if="${bookmark.sourceUrl}" class="snippet-source">
                        <strong>ğŸ”— ì¶œì²˜:</strong>
                        <a th:href="${bookmark.sourceUrl}" target="_blank" rel="noopener noreferrer"
                           th:text="${#strings.abbreviate(bookmark.sourceUrl, 50)}">ì¶œì²˜ URL</a>
                    </div>
                </div>
            </div>

            <!-- ë¶ë§ˆí¬ê°€ ì—†ëŠ” ê²½ìš° -->
            <div th:if="${#lists.isEmpty(bookmarks)}" class="empty-state">
                <div class="emoji">ğŸŒŸ</div>
                <p>ì•„ì§ ë¶ë§ˆí¬í•œ ìŠ¤ë‹ˆí«ì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p>ë§ˆìŒì— ë“œëŠ” ìŠ¤ë‹ˆí«ì„ ë¶ë§ˆí¬í•˜ì—¬ ë‚˜ì¤‘ì— ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”!</p>
                <a th:href="@{/snippets}" class="btn btn-primary">
                    <i class="fas fa-search"></i> ìŠ¤ë‹ˆí« ë‘˜ëŸ¬ë³´ê¸°
                </a>
            </div>
        </div>

        <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
        <div th:if="${userId == null}" class="empty-state">
            <div class="emoji">ğŸ”’</div>
            <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
            <p>ë¶ë§ˆí¬ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <a href="/login" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸í•˜ê¸°
            </a>
        </div>
    </div>
</main>

<script th:inline="javascript">
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°
    const userId = /*[[${userId}]]*/ null;

    console.log('í˜„ì¬ ì‚¬ìš©ì ID:', userId);
    console.log('ë¶ë§ˆí¬ ê°œìˆ˜:', /*[[${count}]]*/ 0);

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    /*[# th:if="${message != null}"]*/
    showAlert(/*[[${message}]]*/ 'ë©”ì‹œì§€', 'success');
    /*[/]*/

    /*[# th:if="${error != null}"]*/
    showAlert(/*[[${error}]]*/ 'ì˜¤ë¥˜', 'error');
    /*[/]*/

    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        document.body.appendChild(alert);

        setTimeout(() => alert.classList.add('show'), 100);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }

    // ë¶ë§ˆí¬ ì œê±° í•¨ìˆ˜ - ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ ì¶”ê°€
    function removeBookmark(snippetId, event) {
        // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ (ì¹´ë“œ í´ë¦­ ë°©ì§€)
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        if (!userId) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        if (!confirm('ì •ë§ë¡œ ì´ ë¶ë§ˆí¬ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        console.log('ë¶ë§ˆí¬ ì œê±° ì‹œë„:', snippetId);

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/bookmark/remove/' + snippetId;

        // CSRF í† í° ì²˜ë¦¬
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

        if (csrfToken && csrfHeader) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }

    // ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥ ê°œì„ 
    document.addEventListener('DOMContentLoaded', function() {
        if (!userId) {
            console.log('ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì - ê²€ìƒ‰ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
            return;
        }

        const searchInput = document.getElementById('bookmarkSearchInput');
        const typeFilter = document.getElementById('bookmarkTypeFilter');
        const bookmarksContainer = document.getElementById('bookmarksContainer');

        if (searchInput && typeFilter && bookmarksContainer) {
            function filterBookmarks() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const bookmarkCards = bookmarksContainer.querySelectorAll('.bookmark-card');

                let visibleCount = 0;

                bookmarkCards.forEach(card => {
                    const memo = (card.getAttribute('data-memo') || '').toLowerCase();
                    const content = (card.getAttribute('data-content') || '').toLowerCase();
                    const type = card.getAttribute('data-type') || '';
                    const snippetId = card.getAttribute('data-snippet-id') || '';

                    const matchesSearch = !searchTerm ||
                        memo.includes(searchTerm) ||
                        content.includes(searchTerm) ||
                        snippetId.toString().includes(searchTerm);
                    const matchesType = !selectedType || type === selectedType;

                    if (matchesSearch && matchesType) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ ì²˜ë¦¬
                const existingNoResults = document.getElementById('bookmarkNoResults');
                if (existingNoResults) {
                    existingNoResults.remove();
                }

                if (visibleCount === 0 && bookmarkCards.length > 0) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.id = 'bookmarkNoResults';
                    noResultsDiv.className = 'empty-state';
                    noResultsDiv.innerHTML =
                        '<div class="emoji">ğŸ”</div>' +
                        '<h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>' +
                        '<p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>';
                    bookmarksContainer.appendChild(noResultsDiv);
                }
            }

            searchInput.addEventListener('input', filterBookmarks);
            typeFilter.addEventListener('change', filterBookmarks);
        }
    });
</script>

<style>
    /* ì¶”ê°€ ìŠ¤íƒ€ì¼ë§ */
    .bookmark-card {
        position: relative;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .bookmark-card.has-color {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.95) 100%);
    }

    .color-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: bold;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        min-width: 40px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .color-name {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 60px;
    }

    .language-badge {
        background: #2196F3;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        margin-bottom: 8px;
        display: inline-block;
    }

    .color-info {
        font-size: 0.8em;
        font-weight: bold;
    }

    .image-container {
        position: relative;
        margin-bottom: 8px;
    }

    .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        object-fit: cover;
    }

    .image-error {
        padding: 20px;
        text-align: center;
        background: #f5f5f5;
        border-radius: 8px;
        color: #666;
    }

    .snippet-source {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #eee;
        font-size: 0.9em;
    }

    .snippet-source a {
        color: #2196F3;
        text-decoration: none;
    }

    .snippet-source a:hover {
        text-decoration: underline;
    }

    /* ë©”ì¸ ì»¨í…ì¸ ê°€ ì‚¬ì´ë“œë°”ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì • */
    .main-content .container {
        max-width: none;
        padding: 20px;
    }

    /* ìƒ‰ìƒë³„ ì¹´ë“œ ë°°ê²½ íš¨ê³¼ */
    .bookmark-card.has-color::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--snippet-color);
        border-radius: 8px 8px 0 0;
    }

    /* í˜¸ë²„ íš¨ê³¼ ê°œì„  */
    .bookmark-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
</style>

</body>
</html>